<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MFAS PDV </title>
  <style>
    :root{
      --bg1:#25106f;
      --bg2:#0b4aa8;
      --bg3:#0aa7d6;
      --card:#ffffff;
      --ink:#0c1020;
      --muted:#5a6072;

      --green:#3be26a;
      --green2:#00c853;
      --yellow:#ffd84a;
      --orange:#ff7a3d;
      --red:#ff4d6d;
      --purple:#7b3cff;
      --cyan:#18d6ff;

      --shadow: 0 18px 50px rgba(0,0,0,.25);
      --shadow2: 0 10px 25px rgba(0,0,0,.16);
      --radius: 22px;
      --radius2: 16px;

      --stroke: rgba(18, 28, 65, 0.10);
      --stroke2: rgba(18, 28, 65, 0.16);

      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--ink);
      background:
        radial-gradient(900px 450px at 15% 15%, rgba(255,216,74,.35), transparent 60%),
        radial-gradient(900px 450px at 85% 25%, rgba(24,214,255,.32), transparent 60%),
        radial-gradient(1000px 520px at 50% 110%, rgba(123,60,255,.28), transparent 60%),
        linear-gradient(135deg, var(--bg1), var(--bg2) 55%, var(--bg3));
      overflow-x:hidden;
    }

    body:before{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      background-image:
        radial-gradient(circle at 10% 20%, rgba(255,255,255,.55) 0 2px, transparent 3px),
        radial-gradient(circle at 25% 70%, rgba(255,216,74,.65) 0 2px, transparent 3px),
        radial-gradient(circle at 75% 30%, rgba(59,226,106,.55) 0 2px, transparent 3px),
        radial-gradient(circle at 90% 75%, rgba(255,122,61,.55) 0 2px, transparent 3px),
        radial-gradient(circle at 45% 45%, rgba(255,77,109,.45) 0 2px, transparent 3px),
        radial-gradient(circle at 60% 80%, rgba(24,214,255,.45) 0 2px, transparent 3px);
      background-size: 220px 220px;
      opacity:.55;
      mix-blend-mode: screen;
      filter: blur(.15px);
    }

    /* ===== Layout mais "tela cheia" ===== */
    .wrap{
      width: min(98vw, 1680px);
      margin: 10px auto;
      padding: 14px;
    }

    /* Top Bar */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      margin-bottom:14px;
    }

    .brand{
      display:flex; align-items:center; gap:12px;
      padding:12px 14px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 999px;
      box-shadow: 0 10px 30px rgba(0,0,0,.18);
      backdrop-filter: blur(8px);
      min-width: 260px;
    }

    /* Logo */
    .logoImg{
      width:46px;height:46px;
      border-radius:16px;
      object-fit:cover;
      box-shadow: 0 12px 24px rgba(0,0,0,.20);
      border: 2px solid rgba(255,255,255,.35);
      background: rgba(255,255,255,.25);
      display:grid;
      place-items:center;
      font-weight:900;
      color:#fff;
      letter-spacing:.5px;
    }

    .brand h1{
      margin:0;
      font-size:15px;
      letter-spacing:.4px;
      color:#fff;
      line-height:1.1;
      font-weight:1000;
      text-transform:uppercase;
    }

    .right-tools{
      display:grid;
      gap:8px;
      justify-items:end;
    }
    .rt-row{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .pill{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius:999px;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.16);
      color:#fff;
      backdrop-filter: blur(8px);
      box-shadow: 0 10px 26px rgba(0,0,0,.16);
      font-weight:800;
      font-size:13px;
      letter-spacing:.2px;
      cursor:pointer;
      user-select:none;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      background: var(--green);
      box-shadow: 0 0 0 6px rgba(59,226,106,.18);
    }
    .dot.closed{
      background: var(--red);
      box-shadow: 0 0 0 6px rgba(255,77,109,.16);
    }
    .dot.role-operator{
      background: var(--orange);
      box-shadow: 0 0 0 6px rgba(255,122,61,.18);
    }
    .dot.role-manager{
      background: var(--green);
      box-shadow: 0 0 0 6px rgba(59,226,106,.18);
    }

    .btn{
      cursor:pointer;
      user-select:none;
      border:0;
      padding:12px 14px;
      border-radius:999px;
      font-weight:1000;
      letter-spacing:.3px;
      color:#1a1f2f;
      background:
        linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.78));
      box-shadow: 0 14px 30px rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.35);
      display:flex; align-items:center; gap:10px;
    }
    .btn .icon{
      width:34px;height:34px;border-radius:14px;
      background: linear-gradient(135deg, var(--yellow), var(--orange));
      display:grid;place-items:center;
      box-shadow: 0 10px 18px rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.55);
    }

    /* Layout */
    .grid{
      display:grid;
      grid-template-columns: 1.45fr .90fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .right-tools{justify-items:start}
      .rt-row{justify-content:flex-start}
    }

    /* Cards */
    .card{
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(255,255,255,.5);
      border-radius: var(--radius);
      box-shadow: 0 18px 50px rgba(0,0,0,.25);
      overflow:hidden;
      position:relative;
    }
    .card:before{
      content:"";
      position:absolute; inset:-2px;
      border-radius:inherit;
      padding:2px;
      background:
        linear-gradient(135deg, rgba(255,216,74,.75), rgba(24,214,255,.65), rgba(123,60,255,.65), rgba(255,77,109,.55));
      -webkit-mask:
        linear-gradient(#000 0 0) content-box,
        linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      pointer-events:none;
      opacity:.55;
    }

    .card-head{
      padding:16px 16px 12px 16px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .title{
      margin:0;
      font-size:18px;
      letter-spacing:.2px;
    }
    .subtitle{
      margin:4px 0 0 0;
      color:var(--muted);
      font-weight:800;
      font-size:13px;
    }

    .tag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:999px;
      font-weight:1000;
      font-size:12px;
      letter-spacing:.35px;
      color:#0b1020;
      background: linear-gradient(135deg, var(--yellow), var(--orange));
      box-shadow: 0 10px 25px rgba(0,0,0,.16);
      border:1px solid rgba(255,255,255,.7);
      white-space:nowrap;
    }

    .card-body{padding:0 16px 16px 16px}

    /* Search + categories */
    .searchRow{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:10px;
      align-items:center;
    }
    .search{
      flex: 1 1 280px;
      display:flex; align-items:center; gap:10px;
      padding:12px 14px;
      border-radius: 999px;
      border: 1px solid rgba(18,28,65,.16);
      background:#fff;
      box-shadow: 0 10px 20px rgba(0,0,0,.08);
    }
    .search input{
      border:0; outline:0; width:100%;
      font-size:14px; font-weight:900;
    }
    .chips{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:12px;
    }
    .chip{
      padding:10px 12px;
      border-radius:999px;
      font-weight:1000;
      font-size:12px;
      border:1px solid rgba(18,28,65,.16);
      background: rgba(255,255,255,.9);
      box-shadow: 0 10px 18px rgba(0,0,0,.08);
      cursor:pointer;
      user-select:none;
    }
    .chip.active{
      background: linear-gradient(135deg, rgba(59,226,106,.25), rgba(24,214,255,.18));
      border-color: rgba(24,214,255,.35);
    }

    /* Product list */
    .products{
      margin-top:14px;
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:12px;
    }
    @media (max-width: 540px){
      .products{grid-template-columns:1fr}
    }

    .prod{
      background:#fff;
      border:1px solid rgba(18,28,65,.16);
      border-radius: 16px;
      box-shadow: 0 14px 26px rgba(0,0,0,.10);
      overflow:hidden;
      position:relative;
    }
    .prod .inner{
      padding:14px;
      display:grid;
      gap:10px;
    }
    .prod h3{
      margin:0;
      font-size:15px;
      letter-spacing:.2px;
    }
    .priceRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .price{
      font-weight:1000;
      font-size:16px;
    }
    .mini{
      color:var(--muted);
      font-weight:800;
      font-size:12px;
    }
    .add{
      border:0;
      cursor:pointer;
      padding:10px 12px;
      border-radius: 14px;
      font-weight:1000;
      letter-spacing:.2px;
      background: linear-gradient(135deg, var(--green), var(--green2));
      color:#072012;
      box-shadow: 0 14px 24px rgba(0,0,0,.16);
      border: 1px solid rgba(255,255,255,.65);
      display:flex; align-items:center; gap:8px;
      justify-content:center;
    }
    .add span{
      width:26px; height:26px;
      border-radius:12px;
      display:grid; place-items:center;
      background: rgba(255,255,255,.35);
      border: 1px solid rgba(255,255,255,.6);
    }

    .prodActions{
      display:flex;
      gap:8px;
      justify-content:flex-end;
      margin-top:2px;
    }
    .miniBtn{
      border:1px solid rgba(18,28,65,.16);
      background: rgba(255,255,255,.9);
      box-shadow: 0 10px 18px rgba(0,0,0,.06);
      border-radius: 14px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:1000;
      font-size:12px;
      color:#1a1f2f;
    }
    .miniBtn.danger{
      border-color: rgba(255,77,109,.35);
      background: rgba(255,77,109,.10);
    }

    /* Cart */
    .cart{
      position:sticky;
      top:14px;
      align-self:start;
    }
    .cartBox{
      padding:14px;
      display:grid;
      gap:12px;
    }
    .cartHeader{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .big{
      margin:0;
      font-size:18px;
      letter-spacing:.2px;
    }
    .orderMeta{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:6px;
    }
    .meta{
      padding:8px 10px;
      border-radius:999px;
      background: rgba(123,60,255,.12);
      border:1px solid rgba(123,60,255,.18);
      font-weight:1000;
      color:#2a1c59;
      font-size:12px;
    }
    .cartItems{
      display:grid; gap:10px;
    }
    .item{
      display:flex;
      gap:10px;
      align-items:center;
      padding:12px;
      background:#fff;
      border:1px solid rgba(18,28,65,.16);
      border-radius:16px;
      box-shadow: 0 12px 22px rgba(0,0,0,.08);
    }
    .emoji{
      width:46px;height:46px;
      border-radius:16px;
      display:grid; place-items:center;
      background: linear-gradient(135deg, rgba(255,216,74,.35), rgba(255,122,61,.22));
      border:1px solid rgba(255,122,61,.22);
      font-size:22px;
    }
    .item h4{margin:0;font-size:14px}
    .item p{margin:2px 0 0 0; font-size:12px; color:var(--muted); font-weight:900}
    .qty{
      margin-left:auto;
      display:flex; align-items:center; gap:8px;
      background: rgba(24,214,255,.10);
      border:1px solid rgba(24,214,255,.18);
      padding:8px 10px;
      border-radius:999px;
      font-weight:1000;
      color:#0b3a44;
    }
    .qty button{
      width:28px;height:28px;
      border-radius:12px;
      border:1px solid rgba(24,214,255,.22);
      background:#fff;
      cursor:pointer;
      font-weight:1000;
    }

    .totals{
      margin-top:4px;
      padding:12px;
      border-radius: 18px;
      background: linear-gradient(135deg, rgba(255,216,74,.22), rgba(59,226,106,.18), rgba(24,214,255,.14));
      border: 1px solid rgba(18, 28, 65, 0.10);
      display:grid;
      gap:8px;
    }
    .line{
      display:flex;
      justify-content:space-between;
      font-weight:1000;
      color:#1b2338;
    }
    .line small{color:var(--muted); font-weight:900}
    .grand{
      font-size:18px;
      letter-spacing:.2px;
    }

    .ctaRow{
      display:grid;
      gap:10px;
      margin-top:2px;
    }
    .cta{
      border:0;
      cursor:pointer;
      padding:14px 14px;
      border-radius: 18px;
      font-weight:1100;
      letter-spacing:.2px;
      box-shadow: 0 16px 30px rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.55);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
    }
    .cta.primary{
      background: linear-gradient(135deg, var(--yellow), var(--orange));
      color:#15121b;
    }
    .cta.secondary{
      background: linear-gradient(135deg, rgba(255,255,255,.95), rgba(255,255,255,.78));
      color:#1a1f2f;
    }
    .cta .bubble{
      width:34px;height:34px;border-radius:14px;
      background: rgba(255,255,255,.35);
      border:1px solid rgba(255,255,255,.55);
      display:grid; place-items:center;
    }

    .emptyState{
      padding:14px;
      border-radius:16px;
      border:1px dashed rgba(18,28,65,.22);
      background: rgba(255,255,255,.7);
      color: var(--muted);
      font-weight:1000;
      text-align:center;
    }

    .footerNote{
      margin-top:10px;
      text-align:center;
      color: rgba(255,255,255,.78);
      font-weight:900;
      font-size:12px;
    }
    .footerShortcuts{
      margin-top:6px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      justify-content:center;
      font-size:11px;
      color: rgba(255,255,255,.85);
      font-weight:900;
    }
    kbd{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:4px 6px;
      border-radius:8px;
      background: rgba(255,255,255,.9);
      border:1px solid rgba(18,28,65,.18);
      color:#111;
      font-weight:1000;
      font-size:10px;
      min-width:24px;
      box-shadow: 0 6px 12px rgba(0,0,0,.12);
    }

    /* ===== Toasts ===== */
    .toastStack{
      position:fixed;
      right:16px;
      bottom:16px;
      display:grid;
      gap:8px;
      z-index:2000;
      pointer-events:none;
    }
    .toast{
      min-width:220px;
      max-width:320px;
      background:#fff;
      border:1px solid rgba(18,28,65,.16);
      border-left:6px solid rgba(24,214,255,.65);
      border-radius:14px;
      padding:10px 12px;
      box-shadow: 0 12px 24px rgba(0,0,0,.16);
      display:flex;
      gap:10px;
      align-items:flex-start;
      font-weight:900;
      font-size:12px;
      pointer-events:auto;
      animation: toastIn .18s ease-out;
    }
    .toast .ticon{
      width:22px;height:22px;
      border-radius:8px;
      display:grid;place-items:center;
      background: rgba(24,214,255,.14);
      border:1px solid rgba(24,214,255,.25);
      font-size:12px;
    }
    .toast.success{ border-left-color: rgba(59,226,106,.9); }
    .toast.success .ticon{ background: rgba(59,226,106,.18); border-color: rgba(59,226,106,.35); }
    .toast.error{ border-left-color: rgba(255,77,109,.9); }
    .toast.error .ticon{ background: rgba(255,77,109,.18); border-color: rgba(255,77,109,.35); }
    .toast.info{ border-left-color: rgba(24,214,255,.9); }
    @keyframes toastIn{
      from{transform:translateY(6px);opacity:.0}
      to{transform:translateY(0);opacity:1}
    }

    /* ===== Loading ===== */
    .loading{
      position:relative;
      pointer-events:none;
      opacity:.85;
    }
    .loading::after{
      content:"";
      position:absolute;
      right:10px;
      top:50%;
      width:14px;height:14px;
      border-radius:50%;
      border:2px solid rgba(0,0,0,.15);
      border-top-color: rgba(0,0,0,.55);
      transform: translateY(-50%);
      animation: spin .9s linear infinite;
    }
    @keyframes spin{ to{ transform: translateY(-50%) rotate(360deg);} }

    .invalid{
      border-color: rgba(255,77,109,.75) !important;
      box-shadow: 0 0 0 2px rgba(255,77,109,.15) !important;
    }

    .locked{
      opacity:.55;
      filter: grayscale(.2);
      cursor:not-allowed;
    }

    /* ===== Sistema ===== */
    .sysGrid{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:12px;
    }
    @media (max-width: 860px){
      .sysGrid{grid-template-columns:1fr}
    }
    .sysCard{
      background:#fff;
      border:1px solid rgba(18,28,65,.16);
      border-radius:16px;
      padding:12px;
      box-shadow: 0 12px 22px rgba(0,0,0,.08);
      display:grid;
      gap:10px;
    }
    .sysTitle{
      font-weight:1000;
      font-size:14px;
    }
    .diagBox{
      padding:10px;
      border-radius:12px;
      border:1px dashed rgba(18,28,65,.25);
      background: rgba(255,255,255,.7);
      font-size:11px;
      color:#1a1f2f;
      font-weight:900;
      white-space:pre-wrap;
    }
    .logList{
      max-height:180px;
      overflow:auto;
      border:1px solid rgba(18,28,65,.16);
      border-radius:12px;
      background:#fff;
      font-size:11px;
    }
    .logRow{
      padding:8px 10px;
      border-bottom:1px solid rgba(18,28,65,.08);
      display:grid;
      gap:4px;
    }
    .logRow:last-child{border-bottom:0}
    .logMeta{
      display:flex;
      justify-content:space-between;
      font-weight:1000;
      color:#111;
    }
    .logMsg{
      color:var(--muted);
      font-weight:900;
      word-break:break-word;
    }

    .shortcutList{
      display:grid;
      gap:8px;
      font-size:12px;
      font-weight:900;
      color:#1a1f2f;
    }
    .catEditor{
      display:grid;
      gap:10px;
    }
    .catRow{
      display:grid;
      grid-template-columns: 38px 1fr 70px 86px;
      gap:8px;
      align-items:center;
      padding:8px;
      border:1px solid rgba(18,28,65,.12);
      border-radius:12px;
      background:#fff;
    }
    .catPreview{
      width:34px;height:34px;
      border-radius:10px;
      display:grid;place-items:center;
      background: rgba(24,214,255,.12);
      border:1px solid rgba(24,214,255,.2);
      font-size:16px;
    }
    .catRow input{
      width:100%;
      padding:8px 10px;
      border-radius:10px;
      font-size:12px;
      font-weight:900;
    }
    .emojiRow{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .emojiRow input{flex:1}
    .emojiGrid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(36px, 1fr));
      gap:8px;
    }
    .emojiBtn{
      width:34px;height:34px;
      border-radius:10px;
      border:1px solid rgba(18,28,65,.18);
      background:#fff;
      cursor:pointer;
      font-size:16px;
      display:grid;place-items:center;
      box-shadow: 0 6px 12px rgba(0,0,0,.08);
    }
    @media (max-width: 520px){
      .catRow{
        grid-template-columns: 34px 1fr;
      }
      .catRow input[data-field="label"]{ grid-column: 2 / -1; }
      .catRow input[data-field="emoji"]{ grid-column: 1 / -1; }
      .catRow .miniBtn{
        grid-column: 1 / -1;
        width:100%;
        justify-content:center;
      }
    }

    /* ===== Modais ===== */
    .modalOverlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:999;
      overflow-y:auto;
    }
    .modal{
      width:min(720px, 100%);
      background: rgba(255,255,255,.94);
      border: 1px solid rgba(255,255,255,.55);
      border-radius: 22px;
      box-shadow: 0 18px 50px rgba(0,0,0,.25);
      position:relative;
      overflow:hidden;
      max-height: calc(100vh - 36px);
    }
    .modal:before{
      content:"";
      position:absolute; inset:-2px;
      border-radius:inherit;
      padding:2px;
      background:
        linear-gradient(135deg, rgba(255,216,74,.75), rgba(24,214,255,.65), rgba(123,60,255,.65), rgba(255,77,109,.55));
      -webkit-mask:
        linear-gradient(#000 0 0) content-box,
        linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      pointer-events:none;
      opacity:.55;
    }
    .modalHeader{
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(18,28,65,.10);
    }
    .modalHeader h3{
      margin:0;
      font-size:16px;
      letter-spacing:.2px;
    }
    .closeX{
      border:1px solid rgba(18,28,65,.16);
      background: rgba(255,255,255,.9);
      border-radius: 14px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:1000;
    }
    .modalBody{
      padding:16px;
      display:grid;
      gap:12px;
      max-height: calc(100vh - 140px);
      overflow-y:auto;
    }
    .formGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 520px){
      .formGrid{grid-template-columns:1fr}
    }
    .field{
      display:grid;
      gap:6px;
    }
    label{
      font-weight:1000;
      color:#1b2338;
      font-size:12px;
      letter-spacing:.25px;
    }
    input, select, textarea{
      width:100%;
      border:1px solid rgba(18,28,65,.16);
      border-radius: 14px;
      padding:12px 12px;
      font-weight:900;
      font-size:13px;
      outline:none;
      box-shadow: 0 10px 18px rgba(0,0,0,.06);
      background: #fff;
    }
    textarea{min-height:80px;resize:vertical}
    .modalFooter{
      padding:14px 16px 16px 16px;
      display:flex;
      gap:10px;
      justify-content:flex-end;
    }
    .btnGhost{
      border:1px solid rgba(18,28,65,.16);
      background: rgba(255,255,255,.88);
      border-radius: 999px;
      padding:12px 14px;
      cursor:pointer;
      font-weight:1000;
    }

    /* Segmented buttons */
    .seg{
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .seg button{
      border:1px solid rgba(18,28,65,.16);
      background: rgba(255,255,255,.92);
      border-radius: 999px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:1000;
      box-shadow: 0 10px 18px rgba(0,0,0,.06);
    }
    .seg button.active{
      background: linear-gradient(135deg, rgba(59,226,106,.25), rgba(24,214,255,.18));
      border-color: rgba(24,214,255,.35);
    }
    .hint{
      font-size:12px;
      color: var(--muted);
      font-weight:900;
    }

    /* ===== Mesas/Cozinha ===== */
    .opsGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 820px){
      .opsGrid{grid-template-columns:1fr}
    }
    .opsCard{
      background:#fff;
      border:1px solid rgba(18,28,65,.16);
      border-radius:16px;
      padding:12px;
      box-shadow: 0 12px 22px rgba(0,0,0,.08);
      display:grid;
      gap:10px;
    }
    .opsItem{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px;
      border-radius:12px;
      background: rgba(24,214,255,.10);
      border:1px solid rgba(24,214,255,.18);
    }
    .opsTitle{
      font-weight:1000;
      font-size:13px;
    }
    .opsMeta{
      font-size:11px;
      color: var(--muted);
      font-weight:900;
      margin-top:2px;
    }
    .opsEmpty{
      padding:10px;
      border-radius:12px;
      border:1px dashed rgba(18,28,65,.22);
      background: rgba(255,255,255,.7);
      color: var(--muted);
      font-weight:1000;
      text-align:center;
      font-size:12px;
    }

    /* ===== Relat√≥rios ===== */
    .reportGrid{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:12px;
    }
    @media (max-width: 640px){
      .reportGrid{grid-template-columns:1fr}
    }
    .reportCard{
      background:#fff;
      border:1px solid rgba(18,28,65,.16);
      border-radius:16px;
      padding:12px;
      box-shadow: 0 12px 22px rgba(0,0,0,.08);
      display:grid;
      gap:10px;
      align-content:start;
    }
    .reportTitle{
      font-weight:1000;
      font-size:14px;
    }
    .reportMeta{
      font-size:12px;
      color: var(--muted);
      font-weight:900;
    }
    .reportCard .btn{
      width:100%;
      justify-content:center;
    }

    /* ===== Mobile Responsivo (sem alterar layout original) ===== */
    @media (max-width: 720px){
      .wrap{width:100%; margin:0; padding:10px}
      .topbar{flex-direction:column; align-items:stretch; gap:10px}
      .brand{min-width:0; width:100%; justify-content:flex-start}
      .right-tools{width:100%; justify-items:stretch}
      .rt-row{width:100%; justify-content:stretch}
      .pill, .btn{width:100%; justify-content:center}
      .grid{grid-template-columns:1fr}
      .card-head{flex-direction:column; align-items:flex-start}
      .searchRow{flex-direction:column; align-items:stretch}
      .search{width:100%; flex:0 0 auto}
      .products{grid-template-columns:1fr}
      .cart{position:static}
      .ctaRow{grid-template-columns:1fr}
      .formGrid{grid-template-columns:1fr}
      .opsGrid{grid-template-columns:1fr}
      .reportGrid{grid-template-columns:1fr}
      .modal{width:min(95vw, 720px)}
      .card:before{opacity:0}
    }

    @media (max-width: 420px){
      .brand h1{font-size:13px}
      .title, .big{font-size:16px}
      .tag{font-size:11px}
      .price{font-size:15px}
      .qty button{width:26px; height:26px}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header class="topbar">
      <div class="brand">
        <div class="logoImg" aria-hidden="true">MVS</div>
        <div>
          <h1>MVS TECHSOLUTION</h1>
          
        </div>
      </div>

      <div class="right-tools">
        <div class="rt-row rt-top">
          <button class="pill" type="button" id="opsBtn">üçΩÔ∏è Mesas / Cozinha</button>
          <button class="pill" type="button" id="reportsBtn" data-role-only="manager">üìä Relat√≥rios</button>
          <button class="pill" type="button" id="systemBtn">‚öôÔ∏è Sistema</button>
          <div class="pill" id="cashPill" title="Clique para abrir/fechar o caixa" data-role-only="manager">
            <span class="dot" id="cashDot"></span>
            <span id="cashText">Caixa: ABERTO</span>
          </div>
          <button class="pill" type="button" id="rolePill" title="Operador/Gerente">
            <span class="dot" id="roleDot"></span>
            <span id="roleText">Modo: Operador</span>
          </button>
          <div class="pill">üïí <span id="clock">--:--</span></div>
        </div>
        <div class="rt-row rt-bottom">
          <button class="btn" type="button" id="importXmlBtn" data-role-only="manager" style="padding:12px 14px">
            <span class="icon">üì•</span>Importar XML
          </button>
          <button class="btn" type="button" id="newProductBtn" data-role-only="manager" style="padding:12px 14px">
            <span class="icon">‚ûï</span>Cadastrar Produto
          </button>
          <button class="btn" type="button" id="manageCategoriesBtn" data-role-only="manager" style="padding:12px 14px">
            <span class="icon">‚úèÔ∏è</span>Editar Categorias
          </button>
          <button class="btn" type="button" onclick="window.open('https://wa.me/5512933008987','_blank')">
            <span class="icon">üì≤</span>Suporte
          </button>
        </div>
      </div>
    </header>

    <main class="grid">
      <!-- ESQUERDA: Produtos -->
      <section class="card">
        <div class="card-head" style="display:none">
          <div>
            <h2 class="title">Produtos</h2>
          </div>
        </div>

        <div class="card-body">
          <div class="searchRow">
            <div class="search" role="search">
              üîé <input id="searchInput" placeholder="Buscar: pizza, bebida, sobremesa..." />
            </div>
            <input id="xmlFileInput" type="file" accept=".xml,text/xml" style="display:none" />
          </div>

          <div class="chips" aria-label="Categorias" id="categoryTabs"></div>
          <h2 class="title" id="productsTitle" style="margin:10px 0 0 0; display:none">Produtos</h2>

          <div class="products" id="products"></div>
        </div>
      </section>

      <!-- DIREITA: Carrinho -->
      <aside class="card cart">
        <div class="cartBox">
          <div class="cartHeader">
            <div>
              <h2 class="big">Pedido Atual</h2>
              <div class="orderMeta">
                <div class="meta" id="metaType">Entrega</div>
                <div class="meta">Comanda</div>
                <div class="meta" id="metaPay">Pagamento</div>
              </div>
            </div>
            <div class="tag">üßæ Total</div>
          </div>

          <div class="cartItems" id="cartItems">
            <div class="emptyState" id="emptyState">
              Carrinho vazio ü§ñüçï<br/>Clique em <b>Adicionar</b>.
            </div>
          </div>

          <div class="totals">
            <div class="line"><small>Subtotal</small><span id="subtotal">R$ 0,00</span></div>
            <div class="line"><small>Desconto</small><span id="discount">R$ 0,00</span></div>
            <div class="line"><small>Taxa</small><span id="fee">R$ 0,00</span></div>
            <div class="line grand"><span>Total</span><span id="total">R$ 0,00</span></div>
          </div>

          <div class="ctaRow">
            <button class="cta primary" type="button" id="finishBtn">
              <span class="bubble">‚úÖ</span>Finalizar e Imprimir
            </button>
            <button class="cta secondary" type="button" id="clearBtn">
              <span class="bubble">üßπ</span>Limpar Carrinho
            </button>
          </div>
        </div>
      </aside>
    </main>

    <div class="footerNote">
      MVS TECHSOLUTION ‚Ä¢ PDV Local ‚Ä¢ comanda 80mm (n√£o fiscal)
      <div class="footerShortcuts">
        Atalhos:
        <kbd>F2</kbd> Finalizar
        <kbd>F4</kbd> Reimprimir
        <kbd>Ctrl</kbd>+<kbd>P</kbd> Reimprimir
        <kbd>Esc</kbd> Fechar
      </div>
    </div>
  </div>

  <!-- MODAL: CADASTRAR/EDITAR PRODUTO -->
  <div class="modalOverlay" id="productModal">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHeader">
        <h3 id="productModalTitle">Cadastrar Produto</h3>
        <button class="closeX" type="button" id="productClose">‚úñ</button>
      </div>

      <div class="modalBody">
        <div class="formGrid">
          <div class="field">
            <label>Nome</label>
            <input id="pName" placeholder="Ex: Pizza Calabresa" />
          </div>
          <div class="field">
            <label>Categoria</label>
            <select id="pCategory"></select>
          </div>
        </div>

        <div class="field" id="pizzaSubcatBlock" style="display:none">
            <label>Subcategoria (Pizza)</label>
            <select id="pSubcat"></select>
        </div>


        <div class="formGrid">
          <div class="field">
            <label>Emoji</label>
            <input id="pEmoji" placeholder="üçï" maxlength="2" />
          </div>
          <div class="field">
            <label>Descri√ß√£o</label>
            <input id="pDesc" placeholder="Ex: 8 fatias ‚Ä¢ borda opcional" />
          </div>
        </div>

        <!-- Pre√ßos -->
        <div id="priceSingleBlock" class="field">
          <label>Pre√ßo (R$)</label>
          <input id="pPrice" placeholder="Ex: 12,00" inputmode="decimal" />
          <div class="hint">Para bebidas/extras/sobremesas.</div>
        </div>

        <div id="pricePizzaBlock" style="display:none">
          <div class="formGrid">
            <div class="field">
              <label>Pre√ßo P (R$)</label>
              <input id="pPriceP" placeholder="Ex: 39,90" inputmode="decimal" />
            </div>
            <div class="field">
              <label>Pre√ßo M (R$)</label>
              <input id="pPriceM" placeholder="Ex: 49,90" inputmode="decimal" />
            </div>
          </div>
          <div class="formGrid">
            <div class="field">
              <label>Pre√ßo G (R$)</label>
              <input id="pPriceG" placeholder="Ex: 59,90" inputmode="decimal" />
            </div>
            <div class="field">
              <label>Vai para cozinha?</label>
              <select id="pIsKitchenPizza">
                <option value="1" selected>Sim</option>
                <option value="0">N√£o</option>
              </select>
            </div>
          </div>
          <div class="hint">Pizzas usam pre√ßo por tamanho (P/M/G).</div>
        </div>

        <div class="field" id="kitchenBlock">
          <label>Vai para cozinha?</label>
          <select id="pIsKitchen">
            <option value="1" selected>Sim</option>
            <option value="0">N√£o</option>
          </select>
        </div>

      </div>

      <div class="modalFooter">
        <button class="btnGhost" type="button" id="productCancel">Cancelar</button>
        <button class="btn" type="button" id="productSave" data-role-only="manager">
          <span class="icon">üíæ</span>Salvar
        </button>
      </div>
    </div>
  </div>

  <!-- MODAL: PIZZA PMG + MEIO A MEIO -->
  <div class="modalOverlay" id="pizzaModal">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHeader">
        <h3 id="pizzaTitle">Montar Pizza</h3>
        <button class="closeX" type="button" id="pizzaClose">‚úñ</button>
      </div>

      <div class="modalBody">
        <div class="field">
          <label>Tamanho</label>
          <div class="seg" id="sizeSeg">
            <button type="button" data-size="P">P</button>
            <button type="button" data-size="M" class="active">M</button>
            <button type="button" data-size="G">G</button>
          </div>
        </div>

        <div class="field">
          <label>Tipo</label>
          <div class="seg" id="halfSeg">
            <button type="button" data-half="0" class="active">Inteira</button>
            <button type="button" data-half="1">Meio a meio</button>
          </div>
        </div>

        <div class="formGrid">
          <div class="field">
            <label>Sabor 1</label>
            <select id="flavor1"></select>
          </div>
          <div class="field">
            <label>Sabor 2 (se meio a meio)</label>
            <select id="flavor2"></select>
          </div>
        </div>

        <div class="field">
          <label>Observa√ß√£o</label>
          <input id="pizzaNotes" placeholder="Ex: sem cebola, bem assada..." />
        </div>

        <div class="field">
          <label>Pre√ßo calculado</label>
          <input id="pizzaPrice" readonly />
          <div class="hint">Regra: meio a meio = maior pre√ßo do tamanho escolhido.</div>
        </div>
      </div>

      <div class="modalFooter">
        <button class="btnGhost" type="button" id="pizzaCancel">Cancelar</button>
        <button class="btn" type="button" id="pizzaAdd">
          <span class="icon">‚ûï</span>Adicionar
        </button>
      </div>
    </div>
  </div>

  <!-- MODAL: FINALIZAR (COM PAGAMENTO) -->
  <div class="modalOverlay" id="checkoutModal">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHeader">
        <h3>Finalizar Pedido</h3>
        <button class="closeX" type="button" id="checkoutClose">‚úñ</button>
      </div>

      <div class="modalBody">
        <div class="formGrid">
          <div class="field">
            <label>Tipo</label>
            <select id="orderType">
              <option value="entrega" selected>Entrega</option>
              <option value="retirada">Retirada</option>
              <option value="mesa">Mesa</option>
            </select>
          </div>
          <div class="field">
            <label>Mesa (se for mesa)</label>
            <input id="tableNo" placeholder="Ex: 04" />
          </div>
        </div>

        <div class="formGrid">
          <div class="field">
            <label>Nome do cliente</label>
            <input id="custName" placeholder="Ex: Jo√£o" />
          </div>
          <div class="field">
            <label>Telefone</label>
            <input id="custPhone" placeholder="(11) 99999-9999" />
          </div>
        </div>

        <div class="field">
          <label>Endere√ßo (se entrega)</label>
          <input id="custAddress" placeholder="Rua, n¬∫, bairro..." />
        </div>

        <div class="formGrid" id="paymentRow">
          <div class="field" id="paymentBlock">
            <label>Pagamento</label>
            <select id="paymentMethod">
              <option value="dinheiro" selected>Dinheiro</option>
              <option value="pix">PIX</option>
              <option value="debito">D√©bito</option>
              <option value="credito">Cr√©dito</option>
            </select>
          </div>
          <div class="field">
            <label>Total</label>
            <input id="checkoutTotal" readonly />
          </div>
        </div>

        <div class="field">
          <label>Observa√ß√£o geral</label>
          <textarea id="orderNotes" placeholder="Ex: entregar no port√£o..."></textarea>
        </div>
      </div>

      <div class="modalFooter">
        <button class="btnGhost" type="button" id="checkoutCancel">Cancelar</button>
        <button class="btn" type="button" id="checkoutConfirm">
          <span class="icon">üñ®Ô∏è</span>Salvar e Imprimir
        </button>
      </div>
    </div>
  </div>

  <!-- MODAL: MESAS / COZINHA -->
  <div class="modalOverlay" id="opsModal">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHeader">
        <h3>Mesas e Cozinha</h3>
        <div style="display:flex; gap:8px; align-items:center">
          <button class="btnGhost" type="button" id="opsRefresh">Atualizar</button>
          <button class="closeX" type="button" id="opsClose">‚úñ</button>
        </div>
      </div>

      <div class="modalBody">
        <div class="opsGrid">
          <div class="opsCard">
            <div class="opsTitle">Mesas Abertas</div>
            <div id="opsTables"></div>
          </div>
          <div class="opsCard">
            <div class="opsTitle">Cozinha ‚Ä¢ Pendentes</div>
            <div id="opsKitchen"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: RELAT√ìRIOS -->
  <div class="modalOverlay" id="reportsModal">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHeader">
        <h3>Relat√≥rios</h3>
        <button class="closeX" type="button" id="reportsClose">‚úñ</button>
      </div>

      <div class="modalBody">
        <div class="field">
          <label>Data base</label>
          <input id="reportDate" type="date" />
          <div class="hint">Use a data para gerar o relat√≥rio di√°rio, mensal ou anual.</div>
        </div>

        <div class="reportGrid" id="reportGrid">
          <div class="reportCard">
            <div>
              <div class="reportTitle">üìÖ Di√°rio</div>
              <div class="reportMeta">Vendas do dia selecionado.</div>
            </div>
            <button class="btn reportBtn" type="button" data-report="day">
              <span class="icon">üñ®Ô∏è</span>Gerar
            </button>
          </div>

          <div class="reportCard">
            <div>
              <div class="reportTitle">üóìÔ∏è Mensal</div>
              <div class="reportMeta">Vendas do m√™s da data selecionada.</div>
            </div>
            <button class="btn reportBtn" type="button" data-report="month">
              <span class="icon">üñ®Ô∏è</span>Gerar
            </button>
          </div>

          <div class="reportCard">
            <div>
              <div class="reportTitle">üìÜ Anual</div>
              <div class="reportMeta">Vendas do ano da data selecionada.</div>
            </div>
            <button class="btn reportBtn" type="button" data-report="year">
              <span class="icon">üñ®Ô∏è</span>Gerar
            </button>
          </div>

          <div class="reportCard">
            <div>
              <div class="reportTitle">üßæ √öltimo fechamento</div>
              <div class="reportMeta">Reabre o relat√≥rio do √∫ltimo caixa fechado.</div>
            </div>
            <button class="btn reportBtn" type="button" data-report="last">
              <span class="icon">üñ®Ô∏è</span>Abrir
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: SISTEMA / DIAGN√ìSTICO -->
  <div class="modalOverlay" id="systemModal">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHeader">
        <h3>‚öôÔ∏è Sistema</h3>
        <button class="closeX" type="button" id="systemClose">‚úñ</button>
      </div>

      <div class="modalBody">
        <div class="sysGrid">
          <div class="sysCard">
            <div class="sysTitle">Acesso</div>
            <div class="field">
              <label>PIN do gerente</label>
              <input id="managerPinInput" type="password" placeholder="Digite o PIN" />
            </div>
            <div class="formGrid">
              <button class="btn" type="button" id="managerLoginBtn">Entrar como gerente</button>
              <button class="btnGhost" type="button" id="managerLogoutBtn">Sair para operador</button>
            </div>
            <div class="field">
              <label>Novo PIN (m√≠n. 4)</label>
              <input id="managerNewPinInput" type="password" placeholder="Definir novo PIN" />
            </div>
            <button class="btnGhost" type="button" id="managerSetPinBtn" data-role-only="manager">Alterar PIN</button>
            <div class="hint" id="roleHint">Dica: o PIN padr√£o √© 1234 (troque no primeiro uso).</div>
          </div>

          <div class="sysCard">
            <div class="sysTitle">Backup</div>
            <div class="formGrid">
              <button class="btn" type="button" id="backupExportBtn" data-role-only="manager">
                <span class="icon">‚¨áÔ∏è</span>Exportar
              </button>
              <button class="btnGhost" type="button" id="backupImportBtn" data-role-only="manager">Importar</button>
            </div>
            <input id="backupFileInput" type="file" accept=".sqlite,.db" style="display:none" />
            <div class="hint" id="backupHint">Backup autom√°tico ativo.</div>
          </div>

          <div class="sysCard">
            <div class="sysTitle">Diagn√≥stico</div>
            <div class="diagBox" id="diagInfo">Carregando...</div>
            <div class="formGrid">
              <button class="btnGhost" type="button" id="diagRefreshBtn">Atualizar</button>
              <button class="btnGhost" type="button" id="logClearBtn" data-role-only="manager">Limpar logs</button>
            </div>
            <div class="logList" id="logList"></div>
          </div>

          <div class="sysCard">
            <div class="sysTitle">Atalhos</div>
            <div class="shortcutList">
              <div><kbd>F2</kbd> Finalizar pedido</div>
              <div><kbd>F4</kbd> Reimprimir √∫ltimo</div>
              <div><kbd>Ctrl</kbd>+<kbd>P</kbd> Reimprimir √∫ltimo</div>
              <div><kbd>Esc</kbd> Fechar modal</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: CATEGORIAS -->
  <div class="modalOverlay" id="categoryModal">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHeader">
        <h3>üè∑Ô∏è Categorias</h3>
        <button class="closeX" type="button" id="categoryClose">‚úñ</button>
      </div>
      <div class="modalBody">
        <div class="catEditor" id="categoryList"></div>
        <div class="formGrid" id="categoryAddBox">
          <div class="field">
            <label>Nova categoria</label>
            <input id="categoryAddName" placeholder="Ex: Lanches, A√ßa√≠" />
          </div>
          <div class="field">
            <label>Emoji</label>
            <div class="emojiRow">
              <input id="categoryAddEmoji" placeholder="üçî" />
              <button class="miniBtn" type="button" id="categoryEmojiToggle">Escolher ‚ñæ</button>
            </div>
          </div>
        </div>
        <div class="hint">Dica: edite nome/emoji. Para excluir, a categoria deve estar sem produtos.</div>
      </div>
      <div class="modalFooter">
        <button class="btnGhost" type="button" id="categoryCancel">Fechar</button>
        <button class="btnGhost" type="button" id="categoryAddBtn">Adicionar Categoria</button>
        <button class="btn" type="button" id="categorySave" data-role-only="manager">Salvar Altera√ß√µes</button>
      </div>
    </div>
  </div>

  <!-- MODAL: EMOJIS -->
  <div class="modalOverlay" id="emojiModal">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHeader">
        <h3>üòÄ Escolher Emoji</h3>
        <button class="closeX" type="button" id="emojiClose">‚úñ</button>
      </div>
      <div class="modalBody">
        <div class="emojiGrid" id="emojiGrid"></div>
      </div>
    </div>
  </div>

  <!-- TOASTS -->
  <div class="toastStack" id="toastStack" aria-live="polite" aria-atomic="true"></div>

  <script>
    // ===== Helpers =====
    const brl = (value) => value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    const escapeHtml = (s) => String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    const escapeAttr = (s) => String(s ?? "")
      .replaceAll("&","&amp;").replaceAll('"',"&quot;").replaceAll("'","&#039;");

    function uid(){
      return (crypto?.randomUUID?.() ?? ('id-' + Math.random().toString(16).slice(2)));
    }

    function parsePrice(input){
      const normalized = String(input ?? '').trim().replace(/\./g,'').replace(',', '.');
      const v = Number(normalized);
      return Number.isFinite(v) ? v : NaN;
    }

    // ===== Demo Storage Mode (Web/Vercel sem SQLite) =====
    function shouldUseDemoStorageMode(){
      const params = new URLSearchParams(window.location.search);
      const force = String(params.get("demo") || "").toLowerCase();
      if (force === "1" || force === "true" || force === "on") return true;
      if (force === "0" || force === "false" || force === "off") return false;

      const host = String(window.location.hostname || "").toLowerCase();
      const isLocalHost = host === "localhost" || host === "127.0.0.1" || host === "";
      const isElectron = /electron/i.test(String(navigator.userAgent || ""));
      return !isLocalHost && !isElectron;
    }

    const DEMO_STORAGE_MODE = shouldUseDemoStorageMode();
    window.__MVS_DEMO_STORAGE = DEMO_STORAGE_MODE;

    if (DEMO_STORAGE_MODE) {
      installDemoStorageApiShim();
    }

    function installDemoStorageApiShim(){
      const DEMO_DB_KEY = "mvs_demo_backend_v1";
      const nativeFetch = window.fetch.bind(window);
      const nativeOpen = window.open.bind(window);

      function demoNowIso(){
        return new Date().toISOString();
      }

      function demoCreateBaseDb(){
        const now = demoNowIso();
        return {
          version: 1,
          seq: { order: 1, item: 1 },
          meta: {
            last_order_number: 0,
            cash_status: "ABERTO",
            cash_opened_at: now,
            cash_last_opened_at: "",
            cash_last_closed_at: "",
            last_backup_at: "",
            last_backup_path: ""
          },
          orders: [],
          order_items: []
        };
      }

      function demoNormalizeDb(raw){
        const base = demoCreateBaseDb();
        const source = (raw && typeof raw === "object") ? raw : {};
        const normalized = {
          version: 1,
          seq: {
            order: Math.max(1, Number(source?.seq?.order || base.seq.order)),
            item: Math.max(1, Number(source?.seq?.item || base.seq.item)),
          },
          meta: {
            last_order_number: Math.max(0, Number(source?.meta?.last_order_number || base.meta.last_order_number)),
            cash_status: String(source?.meta?.cash_status || base.meta.cash_status).toUpperCase() === "FECHADO" ? "FECHADO" : "ABERTO",
            cash_opened_at: String(source?.meta?.cash_opened_at || base.meta.cash_opened_at),
            cash_last_opened_at: String(source?.meta?.cash_last_opened_at || ""),
            cash_last_closed_at: String(source?.meta?.cash_last_closed_at || ""),
            last_backup_at: String(source?.meta?.last_backup_at || ""),
            last_backup_path: String(source?.meta?.last_backup_path || ""),
          },
          orders: Array.isArray(source?.orders) ? source.orders : [],
          order_items: Array.isArray(source?.order_items) ? source.order_items : []
        };

        const maxOrderId = normalized.orders.reduce((acc, o) => Math.max(acc, Number(o?.id || 0)), 0);
        const maxItemId = normalized.order_items.reduce((acc, it) => Math.max(acc, Number(it?.id || 0)), 0);
        normalized.seq.order = Math.max(normalized.seq.order, maxOrderId + 1);
        normalized.seq.item = Math.max(normalized.seq.item, maxItemId + 1);
        return normalized;
      }

      function demoLoadDb(){
        try{
          const raw = localStorage.getItem(DEMO_DB_KEY);
          if (!raw) {
            const base = demoCreateBaseDb();
            localStorage.setItem(DEMO_DB_KEY, JSON.stringify(base));
            return base;
          }
          return demoNormalizeDb(JSON.parse(raw));
        } catch {
          const base = demoCreateBaseDb();
          localStorage.setItem(DEMO_DB_KEY, JSON.stringify(base));
          return base;
        }
      }

      function demoSaveDb(db){
        localStorage.setItem(DEMO_DB_KEY, JSON.stringify(demoNormalizeDb(db)));
      }

      function demoJson(data, status = 200){
        return new Response(JSON.stringify(data), {
          status,
          headers: { "Content-Type": "application/json; charset=utf-8" }
        });
      }

      function demoError(message, status = 400){
        return demoJson({ ok: false, error: String(message || "Erro") }, status);
      }

      function demoParseJsonBody(init){
        const body = init?.body;
        if (!body) return {};
        if (typeof body === "string") {
          try { return JSON.parse(body); } catch { return {}; }
        }
        return {};
      }

      async function demoReadBodyText(body){
        if (body == null) return "";
        if (typeof body === "string") return body;
        if (body instanceof ArrayBuffer) {
          return new TextDecoder().decode(new Uint8Array(body));
        }
        if (ArrayBuffer.isView(body)) {
          return new TextDecoder().decode(new Uint8Array(body.buffer, body.byteOffset, body.byteLength));
        }
        if (typeof Blob !== "undefined" && body instanceof Blob) {
          return await body.text();
        }
        return "";
      }

      function demoPaymentBucket(payment){
        const pm = String(payment || "").toLowerCase();
        if (pm.includes("din")) return "dinheiro";
        if (pm.includes("pix")) return "pix";
        if (pm.includes("deb")) return "debito";
        if (pm.includes("cre")) return "credito";
        return "outros";
      }

      function demoOrderTotal(db, orderId){
        return db.order_items
          .filter((it) => Number(it.order_id) === Number(orderId))
          .reduce((acc, it) => acc + (Number(it.qty || 0) * Number(it.unit_price || 0)), 0);
      }

      function demoSumOrdersBetween(db, startIso, endIso){
        const start = new Date(startIso).getTime();
        const end = new Date(endIso).getTime();
        const rows = db.orders
          .filter((o) => {
            const status = String(o.status || "").toUpperCase();
            const ts = new Date(o.created_at).getTime();
            return status === "FECHADO" && Number.isFinite(ts) && ts >= start && ts <= end;
          })
          .map((o) => ({
            id: Number(o.id),
            order_number: Number(o.order_number || 0),
            payment_method: o.payment_method || "",
            created_at: o.created_at || demoNowIso(),
            total: demoOrderTotal(db, o.id),
          }))
          .sort((a, b) => a.id - b.id);

        const byPay = { dinheiro: 0, pix: 0, debito: 0, credito: 0, outros: 0 };
        let totalGeral = 0;
        for (const row of rows){
          const t = Number(row.total || 0);
          totalGeral += t;
          byPay[demoPaymentBucket(row.payment_method)] += t;
        }
        return { rows, byPay, totalGeral };
      }

      function demoParseDateOnly(dateStr){
        const value = String(dateStr || "").trim();
        const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(value);
        if (!m) return new Date();
        const y = Number(m[1]);
        const mo = Number(m[2]) - 1;
        const d = Number(m[3]);
        return new Date(y, mo, d);
      }

      function demoGetReportRange(period, dateStr){
        const p = String(period || "").toLowerCase();
        const base = demoParseDateOnly(dateStr);
        const y = base.getFullYear();
        const m = base.getMonth();
        const d = base.getDate();

        if (["day", "daily", "diario"].includes(p)) {
          return {
            title: "Relatorio Diario (Demo Storage)",
            start: new Date(y, m, d, 0, 0, 0, 0),
            end: new Date(y, m, d, 23, 59, 59, 999),
          };
        }
        if (["month", "monthly", "mensal"].includes(p)) {
          return {
            title: "Relatorio Mensal (Demo Storage)",
            start: new Date(y, m, 1, 0, 0, 0, 0),
            end: new Date(y, m + 1, 0, 23, 59, 59, 999),
          };
        }
        if (["year", "yearly", "annual", "anual"].includes(p)) {
          return {
            title: "Relatorio Anual (Demo Storage)",
            start: new Date(y, 0, 1, 0, 0, 0, 0),
            end: new Date(y, 11, 31, 23, 59, 59, 999),
          };
        }
        return null;
      }

      function demoHtmlPage(title, bodyHtml){
        return `
<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>${escapeHtml(title)}</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:16px;color:#111}
    h1{margin:0 0 8px 0;font-size:18px}
    .muted{opacity:.72}
    .box{border:1px solid #ddd;border-radius:10px;padding:12px;margin:12px 0}
    table{width:100%;border-collapse:collapse;font-size:12px}
    th,td{border-bottom:1px solid #eee;padding:7px;text-align:left}
    th:last-child,td:last-child{text-align:right}
    @media print{ @page{ margin:10mm; } }
  </style>
</head>
<body onload="window.print()">
${bodyHtml}
</body>
</html>
        `.trim();
      }

      function demoBuildOrderPrintHtml(order, items){
        const dt = order?.created_at ? new Date(order.created_at).toLocaleString("pt-BR") : "-";
        const total = items.reduce((acc, it) => acc + (Number(it.qty || 0) * Number(it.unit_price || 0)), 0);
        const rows = items.map((it) => {
          const line = Number(it.qty || 0) * Number(it.unit_price || 0);
          const notes = String(it.notes || "").trim();
          return `
            <tr>
              <td>${escapeHtml(`${it.qty}x ${it.name}`)}${notes ? ` <span class="muted">(${escapeHtml(notes)})</span>` : ""}</td>
              <td>${escapeHtml(brl(line))}</td>
            </tr>
          `;
        }).join("");

        return demoHtmlPage(
          `Comanda #${order?.order_number || "-"}`,
          `
            <h1>Comanda #${escapeHtml(String(order?.order_number || "-"))}</h1>
            <p class="muted">Demo Storage (sem SQLite) - ${escapeHtml(dt)}</p>
            <div class="box">
              <div><b>Tipo:</b> ${escapeHtml(String(order?.order_type || "-").toUpperCase())}</div>
              <div><b>Mesa:</b> ${escapeHtml(order?.table_no || "-")}</div>
              <div><b>Cliente:</b> ${escapeHtml(order?.customer_name || "-")}</div>
              <div><b>Pagamento:</b> ${escapeHtml(String(order?.payment_method || "-").toUpperCase())}</div>
            </div>
            <div class="box">
              <table>
                <thead><tr><th>Item</th><th>Total</th></tr></thead>
                <tbody>${rows || `<tr><td colspan="2">Sem itens</td></tr>`}</tbody>
              </table>
            </div>
            <div class="box"><b>Total:</b> ${escapeHtml(brl(total))}</div>
          `
        );
      }

      function demoBuildReportHtml(title, startIso, endIso, report){
        const dtStart = new Date(startIso).toLocaleString("pt-BR");
        const dtEnd = new Date(endIso).toLocaleString("pt-BR");
        const rows = report.rows.map((r) => `
          <tr>
            <td>#${escapeHtml(String(r.order_number || "-"))}</td>
            <td>${escapeHtml(String(r.payment_method || "-").toUpperCase())}</td>
            <td>${escapeHtml(new Date(r.created_at).toLocaleString("pt-BR"))}</td>
            <td>${escapeHtml(brl(r.total || 0))}</td>
          </tr>
        `).join("");

        return demoHtmlPage(
          title,
          `
            <h1>${escapeHtml(title)}</h1>
            <p class="muted">Periodo: <b>${escapeHtml(dtStart)}</b> ate <b>${escapeHtml(dtEnd)}</b></p>
            <div class="box">
              <div><b>Pedidos:</b> ${report.rows.length}</div>
              <div><b>Total:</b> ${escapeHtml(brl(report.totalGeral || 0))}</div>
              <div>Dinheiro: ${escapeHtml(brl(report.byPay?.dinheiro || 0))}</div>
              <div>Pix: ${escapeHtml(brl(report.byPay?.pix || 0))}</div>
              <div>Debito: ${escapeHtml(brl(report.byPay?.debito || 0))}</div>
              <div>Credito: ${escapeHtml(brl(report.byPay?.credito || 0))}</div>
            </div>
            <div class="box">
              <table>
                <thead>
                  <tr><th>Pedido</th><th>Pagamento</th><th>Data/Hora</th><th>Total</th></tr>
                </thead>
                <tbody>${rows || `<tr><td colspan="4">Sem vendas no periodo</td></tr>`}</tbody>
              </table>
            </div>
          `
        );
      }

      function demoOpenHtml(html, target, features){
        const blob = new Blob([html], { type: "text/html;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const win = nativeOpen(url, target || "_blank", features);
        setTimeout(() => URL.revokeObjectURL(url), 60_000);
        return win;
      }

      function demoHandleApiOpen(urlObj, target, features){
        const path = urlObj.pathname;
        const db = demoLoadDb();

        const orderPrint = path.match(/^\/api\/orders\/(\d+)\/print$/);
        if (orderPrint){
          const orderId = Number(orderPrint[1]);
          const order = db.orders.find((o) => Number(o.id) === orderId);
          if (!order) {
            return demoOpenHtml(demoHtmlPage("Pedido nao encontrado", "<h1>Pedido nao encontrado</h1>"), target, features);
          }
          const items = db.order_items.filter((it) => Number(it.order_id) === orderId);
          return demoOpenHtml(demoBuildOrderPrintHtml(order, items), target, features);
        }

        if (path === "/api/cash/report/print"){
          const start = db.meta.cash_last_opened_at || db.meta.cash_opened_at || new Date(0).toISOString();
          const end = db.meta.cash_last_closed_at || demoNowIso();
          const report = demoSumOrdersBetween(db, start, end);
          return demoOpenHtml(demoBuildReportHtml("Relatorio de Caixa (Demo Storage)", start, end, report), target, features);
        }

        if (path === "/api/reports/print"){
          const range = demoGetReportRange(urlObj.searchParams.get("period"), urlObj.searchParams.get("date"));
          if (!range){
            return demoOpenHtml(demoHtmlPage("Parametros invalidos", "<h1>Parametros invalidos</h1>"), target, features);
          }
          const start = range.start.toISOString();
          const end = range.end.toISOString();
          const report = demoSumOrdersBetween(db, start, end);
          return demoOpenHtml(demoBuildReportHtml(range.title, start, end, report), target, features);
        }

        return null;
      }

      async function demoHandleApiFetch(urlObj, init = {}){
        const method = String(init?.method || "GET").toUpperCase();
        const path = urlObj.pathname;
        const db = demoLoadDb();

        if (method === "GET" && path === "/api/cash/status"){
          return demoJson({
            ok: true,
            cash_status: db.meta.cash_status,
            opened_at: db.meta.cash_opened_at,
            last_closed_at: db.meta.cash_last_closed_at,
          });
        }

        if (method === "POST" && path === "/api/cash/open"){
          db.meta.cash_status = "ABERTO";
          db.meta.cash_opened_at = demoNowIso();
          demoSaveDb(db);
          return demoJson({ ok: true });
        }

        if (method === "POST" && path === "/api/cash/close"){
          if (db.meta.cash_status !== "ABERTO") {
            return demoError("Caixa ja esta fechado", 400);
          }
          const start = db.meta.cash_opened_at || new Date(0).toISOString();
          const end = demoNowIso();
          const report = demoSumOrdersBetween(db, start, end);
          db.meta.cash_status = "FECHADO";
          db.meta.cash_last_opened_at = start;
          db.meta.cash_last_closed_at = end;
          db.meta.last_backup_at = end;
          db.meta.last_backup_path = "demo_auto_cash_close";
          demoSaveDb(db);
          return demoJson({
            ok: true,
            start,
            end,
            total: report.totalGeral,
            byPay: report.byPay,
            count: report.rows.length
          });
        }

        if (method === "GET" && path === "/api/tables/open"){
          const rows = db.orders
            .filter((o) => String(o.order_type || "") === "mesa" && String(o.status || "").toUpperCase() === "ABERTO")
            .map((o) => ({
              id: Number(o.id),
              order_number: Number(o.order_number || 0),
              table_no: String(o.table_no || ""),
              created_at: o.created_at || demoNowIso(),
              customer_name: String(o.customer_name || ""),
              total: demoOrderTotal(db, o.id)
            }))
            .sort((a, b) => b.id - a.id);
          return demoJson({ ok: true, rows });
        }

        if (method === "GET" && path === "/api/kitchen/pending"){
          const orderById = new Map(db.orders.map((o) => [Number(o.id), o]));
          const rows = db.order_items
            .filter((it) => Number(it.is_kitchen) === 1 && (!it.status || String(it.status).toUpperCase() === "PENDENTE"))
            .map((it) => {
              const order = orderById.get(Number(it.order_id));
              if (!order) return null;
              return {
                id: Number(it.id),
                order_id: Number(it.order_id),
                name: String(it.name || "Item"),
                qty: Number(it.qty || 1),
                notes: String(it.notes || ""),
                order_number: Number(order.order_number || 0),
                table_no: String(order.table_no || ""),
                order_type: String(order.order_type || ""),
                created_at: order.created_at || demoNowIso(),
              };
            })
            .filter(Boolean)
            .sort((a, b) => a.id - b.id);
          return demoJson({ ok: true, rows });
        }

        const orderGetMatch = path.match(/^\/api\/orders\/(\d+)$/);
        if (method === "GET" && orderGetMatch){
          const id = Number(orderGetMatch[1]);
          const order = db.orders.find((o) => Number(o.id) === id);
          if (!order) return demoError("Pedido nao encontrado", 404);
          const items = db.order_items.filter((it) => Number(it.order_id) === id);
          return demoJson({ ok: true, order, items });
        }

        const kitchenReadyMatch = path.match(/^\/api\/kitchen\/item\/(\d+)\/ready$/);
        if (method === "POST" && kitchenReadyMatch){
          const id = Number(kitchenReadyMatch[1]);
          const item = db.order_items.find((it) => Number(it.id) === id);
          if (!item) return demoError("Item nao encontrado", 400);
          item.status = "PRONTO";
          demoSaveDb(db);
          return demoJson({ ok: true });
        }

        const orderFinalizeMatch = path.match(/^\/api\/orders\/(\d+)\/finalize$/);
        if (method === "POST" && orderFinalizeMatch){
          const id = Number(orderFinalizeMatch[1]);
          const payload = demoParseJsonBody(init);
          const order = db.orders.find((o) => Number(o.id) === id);
          if (!order) return demoError("Pedido nao encontrado", 404);
          if (String(order.status || "").toUpperCase() !== "ABERTO") {
            return demoError("Pedido ja esta fechado", 400);
          }
          const payment = String(payload.payment_method || "").trim();
          if (!payment) return demoError("Informe o pagamento", 400);

          order.order_type = payload.order_type || order.order_type || "mesa";
          order.table_no = payload.table_no || order.table_no || "";
          order.customer_name = payload.customer_name || order.customer_name || "";
          order.customer_phone = payload.customer_phone || order.customer_phone || "";
          order.address = payload.address || order.address || "";
          order.notes = payload.notes || order.notes || "";
          order.payment_method = payment;
          order.status = "FECHADO";

          demoSaveDb(db);
          return demoJson({ ok: true, order_id: id, order_number: order.order_number });
        }

        if (method === "POST" && path === "/api/orders"){
          const payload = demoParseJsonBody(init);
          const items = Array.isArray(payload?.items) ? payload.items : [];
          if (items.length === 0) return demoError("Carrinho vazio", 400);
          if (db.meta.cash_status !== "ABERTO") {
            return demoError("Caixa esta FECHADO. Abra o caixa para vender.", 400);
          }

          const orderId = db.seq.order++;
          const orderNumber = Number(db.meta.last_order_number || 0) + 1;
          db.meta.last_order_number = orderNumber;
          const now = demoNowIso();
          const orderType = String(payload.order_type || "retirada");
          const orderStatus = orderType === "mesa" ? "ABERTO" : "FECHADO";

          db.orders.push({
            id: orderId,
            order_number: orderNumber,
            created_at: now,
            order_type: orderType,
            table_no: String(payload.table_no || ""),
            customer_name: String(payload.customer_name || ""),
            customer_phone: String(payload.customer_phone || ""),
            address: String(payload.address || ""),
            notes: String(payload.notes || ""),
            payment_method: String(payload.payment_method || ""),
            status: orderStatus,
            subtotal: Number(payload?.totals?.subtotal || 0),
            discount: Number(payload?.totals?.discount || 0),
            fee: Number(payload?.totals?.fee || 0),
            total: Number(payload?.totals?.total || 0)
          });

          for (const it of items){
            const itemId = db.seq.item++;
            db.order_items.push({
              id: itemId,
              order_id: orderId,
              name: String(it?.name || "Item"),
              qty: Number(it?.qty || 1),
              unit_price: Number(it?.unit_price || 0),
              notes: String(it?.notes || ""),
              is_kitchen: it?.is_kitchen ? 1 : 0,
              status: "PENDENTE"
            });
          }

          demoSaveDb(db);
          return demoJson({ ok: true, order_id: orderId, order_number: orderNumber });
        }

        if (method === "GET" && path === "/api/diag"){
          const raw = localStorage.getItem(DEMO_DB_KEY) || "";
          const size = new Blob([raw]).size;
          return demoJson({
            ok: true,
            app: {
              version: "demo-storage",
              node: "n/a",
              platform: "web",
              arch: navigator.platform || "browser",
              uptime: Number((performance.now() / 1000).toFixed(0)),
            },
            db: {
              path: `localStorage:${DEMO_DB_KEY}`,
              size,
              orders: db.orders.length,
              items: db.order_items.length,
              cash_status: db.meta.cash_status,
              last_backup_at: db.meta.last_backup_at,
              last_backup_path: db.meta.last_backup_path,
            }
          });
        }

        if (method === "GET" && path === "/api/backup/export"){
          db.meta.last_backup_at = demoNowIso();
          db.meta.last_backup_path = "demo_manual_export";
          demoSaveDb(db);
          const text = JSON.stringify(db, null, 2);
          return new Response(text, {
            status: 200,
            headers: {
              "Content-Type": "application/json; charset=utf-8",
              "X-MVS-Demo": "1"
            }
          });
        }

        if (method === "POST" && path === "/api/backup/import"){
          const text = await demoReadBodyText(init?.body);
          if (!text) return demoError("Arquivo invalido", 400);
          let parsed;
          try {
            parsed = JSON.parse(text);
          } catch {
            return demoError("Backup demo invalido (esperado JSON)", 400);
          }
          const imported = demoNormalizeDb(parsed);
          demoSaveDb(imported);
          return demoJson({ ok: true });
        }

        return demoError("Rota demo nao implementada", 404);
      }

      window.fetch = async (input, init) => {
        let urlObj = null;
        try {
          if (typeof input === "string") {
            urlObj = new URL(input, window.location.origin);
          } else if (input && typeof input.url === "string") {
            urlObj = new URL(input.url, window.location.origin);
          }
        } catch {}

        if (urlObj && urlObj.pathname.startsWith("/api/")) {
          return demoHandleApiFetch(urlObj, init || {});
        }

        return nativeFetch(input, init);
      };

      window.open = (url, target, features) => {
        let urlObj = null;
        try { urlObj = new URL(String(url), window.location.origin); } catch {}

        if (urlObj && urlObj.pathname.startsWith("/api/")) {
          const handled = demoHandleApiOpen(urlObj, target, features);
          if (handled) return handled;
        }

        return nativeOpen(url, target, features);
      };
    }

    // ===== Toasts + Logs =====
    const LS_LOGS = "mvs_logs_v1";
    const toastStack = document.getElementById("toastStack");
    let logs = (() => {
      try{
        const raw = localStorage.getItem(LS_LOGS);
        const parsed = raw ? JSON.parse(raw) : [];
        return Array.isArray(parsed) ? parsed : [];
      }catch{ return []; }
    })();

    function saveLogs(){
      if (logs.length > 300) logs = logs.slice(-300);
      localStorage.setItem(LS_LOGS, JSON.stringify(logs));
    }

    function logEvent(level, msg, data){
      logs.push({
        ts: new Date().toISOString(),
        level: String(level || "info"),
        msg: String(msg || ""),
        data: data ? String(data) : ""
      });
      saveLogs();
      if (document.getElementById("systemModal")?.style.display === "flex"){
        renderLogs();
      }
    }

    function logError(msg, err){
      const detail = err?.stack || err?.message || String(err || "");
      logEvent("error", msg, detail);
    }

    function toast(message, type = "info", opts = {}){
      if (!toastStack) return;
      const t = document.createElement("div");
      const icon = type === "success" ? "‚úÖ" : type === "error" ? "‚ö†Ô∏è" : "‚ÑπÔ∏è";
      t.className = `toast ${type}`;
      t.innerHTML = `<div class="ticon">${icon}</div><div>${escapeHtml(message)}</div>`;
      toastStack.appendChild(t);

      if (type === "error"){
        logEvent("error", message, opts?.detail || "");
      }

      const timeout = Number(opts.timeout || 3500);
      setTimeout(() => t.remove(), timeout);
    }

    function safePrompt(message, def = ""){
      try{
        // Some environments disable prompt(); handle gracefully
        return window.prompt(message, def);
      } catch (e){
        toast("Entrada por prompt n√£o suportada. Use os campos da tela.", "error");
        return null;
      }
    }

    function setButtonLoading(btn, loading, label){
      if (!btn) return;
      if (loading){
        if (!btn.dataset.origHtml) btn.dataset.origHtml = btn.innerHTML;
        if (label) btn.innerHTML = escapeHtml(label);
        btn.classList.add("loading");
        btn.disabled = true;
      } else {
        if (btn.dataset.origHtml) btn.innerHTML = btn.dataset.origHtml;
        btn.classList.remove("loading");
        btn.disabled = false;
      }
    }

    function setBusy(el, loading){
      if (!el) return;
      el.classList.toggle("loading", !!loading);
      el.setAttribute("aria-busy", loading ? "true" : "false");
    }

    window.addEventListener("error", (e) => {
      logError("Erro JS", e?.error || e?.message || e);
    });
    window.addEventListener("unhandledrejection", (e) => {
      logError("Promise rejeitada", e?.reason || e);
    });

    // ===== Estado Caixa =====
    const LS_SHIFT = "mvs_shift_state_v1";
    const LS_LAST_ORDER = "mvs_last_order_id_v1";
    const LS_ROLE = "mvs_role_v1";
    const LS_MANAGER_PIN = "mvs_manager_pin_v1";
    let shiftState = (() => {
      try{
        const raw = localStorage.getItem(LS_SHIFT);
        if (!raw) return { open: true };
        const parsed = JSON.parse(raw);
        return { open: !!parsed.open };
      }catch{ return { open:true }; }
    })();
    let lastOrderId = (() => {
      try{
        const raw = localStorage.getItem(LS_LAST_ORDER);
        return raw ? String(raw) : null;
      }catch{ return null; }
    })();

    let currentRole = (() => {
      try{
        const raw = localStorage.getItem(LS_ROLE);
        return raw === "gerente" ? "gerente" : "operador";
      }catch{ return "operador"; }
    })();

    let managerPin = (() => {
      try{
        const raw = localStorage.getItem(LS_MANAGER_PIN);
        if (raw && String(raw).trim()) return String(raw);
        localStorage.setItem(LS_MANAGER_PIN, "1234");
        return "1234";
      }catch{
        return "1234";
      }
    })();

    function isManager(){ return currentRole === "gerente"; }
    function setRole(role){
      currentRole = role === "gerente" ? "gerente" : "operador";
      localStorage.setItem(LS_ROLE, currentRole);
      renderRole();
    }

    function applyRoleLocks(){
      const locked = !isManager();
      document.querySelectorAll("[data-role-only='manager']").forEach(el => {
        el.classList.toggle("locked", locked);
        el.setAttribute("aria-disabled", locked ? "true" : "false");
        const tag = el.tagName.toLowerCase();
        if (tag === "button" || tag === "input" || tag === "select" || tag === "textarea"){
          el.disabled = locked;
        }
      });
    }

    function renderRole(){
      const roleText = document.getElementById("roleText");
      const roleDot = document.getElementById("roleDot");
      if (roleText) roleText.textContent = `Modo: ${isManager() ? "Gerente" : "Operador"}`;
      if (roleDot){
        roleDot.classList.remove("role-operator", "role-manager");
        roleDot.classList.add(isManager() ? "role-manager" : "role-operator");
      }
      applyRoleLocks();
    }

    function requireManager(){
      if (isManager()) return true;
      toast("A√ß√£o restrita ao gerente.", "error");
      return false;
    }

    function saveShift(){
      localStorage.setItem(LS_SHIFT, JSON.stringify(shiftState));
    }
    function setLastOrderId(id){
      if (id === undefined || id === null) return;
      lastOrderId = String(id);
      localStorage.setItem(LS_LAST_ORDER, lastOrderId);
    }
    function reprintLastOrder(){
      if (!lastOrderId){
        toast("Nenhum pedido para reimprimir ainda.", "info");
        return;
      }
      window.open(`/api/orders/${lastOrderId}/print?prices=1`, "_blank");
    }

    async function syncCashFromServer(){
      try{
        const resp = await fetch("/api/cash/status");
        if (!resp.ok) throw new Error("status");
        const data = await resp.json();
        if (data?.cash_status){
          shiftState.open = String(data.cash_status).toUpperCase() === "ABERTO";
          saveShift();
          renderShift();
        }
      }catch{
        // mant√©m estado local se o servidor estiver indispon√≠vel
      }
    }

    // ===== Subcategorias de Pizza =====
const LS_SUBCATS = "mvs_pizza_subcats_v1";

function loadPizzaSubcats(){
  try{
    const raw = localStorage.getItem(LS_SUBCATS);
    if (!raw) return ["salgadas", "doces"];
    const arr = JSON.parse(raw);
    if (!Array.isArray(arr) || arr.length === 0) return ["salgadas", "doces"];
    return arr;
  }catch{
    return ["salgadas", "doces"];
  }
}
function savePizzaSubcats(arr){
  localStorage.setItem(LS_SUBCATS, JSON.stringify(arr));
}

let pizzaSubcats = loadPizzaSubcats();
let activePizzaSubcat = "salgadas"; // default

function normalizeSubcat(s){
  return String(s || "").trim().toLowerCase();
}
function defaultPizzaSubcat(){
  return normalizeSubcat(pizzaSubcats[0] || "salgadas");
}
function productSubcat(p){
  return normalizeSubcat(p?.subcat) || defaultPizzaSubcat();
}

function prettySubcat(s){
  const v = String(s||"").toLowerCase();
  if (v === "salgadas") return "üçï Salgadas";
  if (v === "doces") return "üç´ Doces";
  return "üè∑Ô∏è " + (s.charAt(0).toUpperCase() + s.slice(1));
}

function renderPizzaSubTabs(){
  // compat: subcategorias agora ficam ao lado das categorias
  renderCategoryTabs();
}

document.getElementById("newSubcatBtn")?.addEventListener("click", () => {
  const name = safePrompt("Nome da subcategoria (ex: doces, especiais, veganas):");
  if (!name) return;
  const v = name.trim().toLowerCase();
  if (!v) return;

  if (!pizzaSubcats.includes(v)) {
    pizzaSubcats.push(v);
    savePizzaSubcats(pizzaSubcats);
  }
  activePizzaSubcat = v;
  renderPizzaSubTabs();
  // atualiza select do modal se estiver aberto
  syncSubcatSelect();
  renderProducts();
});

function syncSubcatSelect(){
  const block = document.getElementById("pizzaSubcatBlock");
  const select = document.getElementById("pSubcat");
  if (!block || !select) return;

  const isPizza = (document.getElementById("pCategory")?.value === "pizzas");
  block.style.display = isPizza ? "grid" : "none";
  if (!isPizza) return;

  select.innerHTML = pizzaSubcats.map(sc => `<option value="${sc}">${prettySubcat(sc)}</option>`).join("");
  if (!select.value) select.value = activePizzaSubcat || pizzaSubcats[0];
}

    // ===== Categorias =====
    const LS_CATS = "mvs_categories_v1";
    function seedCategories(){
      return [
        { id:"pizzas", label:"Pizzas", emoji:"üçï" },
        { id:"lanches", label:"Lanches", emoji:"üçî" },
        { id:"acai", label:"A√ßa√≠", emoji:"üçß" },
        { id:"bebidas", label:"Bebidas", emoji:"ü•§" },
        { id:"extras", label:"Extras", emoji:"üçü" },
        { id:"sobremesas", label:"Sobremesas", emoji:"üç∞" },
      ];
    }

    function loadCategories(){
      try{
        const raw = localStorage.getItem(LS_CATS);
        if (!raw){
          const seeded = seedCategories();
          localStorage.setItem(LS_CATS, JSON.stringify(seeded));
          return seeded;
        }
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed) || parsed.length === 0) throw new Error("bad");
        const seeded = seedCategories();
        const ids = new Set(parsed.map(c => c.id));
        for (const s of seeded){
          if (!ids.has(s.id)) parsed.push(s);
        }
        localStorage.setItem(LS_CATS, JSON.stringify(parsed));
        return parsed;
      }catch{
        const seeded = seedCategories();
        localStorage.setItem(LS_CATS, JSON.stringify(seeded));
        return seeded;
      }
    }

    function saveCategories(list){
      localStorage.setItem(LS_CATS, JSON.stringify(list));
    }

    function normalizeCatId(name){
      return String(name || "")
        .trim()
        .toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/(^-|-$)/g, "");
    }

    function normalizeCategoryId(raw){
      const id = normalizeCatId(raw);
      if (id === "pizza") return "pizzas";
      if (id === "lanche") return "lanches";
      if (id === "bebida") return "bebidas";
      if (id === "sobremesa") return "sobremesas";
      if (id === "extra") return "extras";
      return id;
    }

    function guessCategoryEmoji(name){
      const n = String(name || "").toLowerCase();
      if (n.includes("pizza")) return "üçï";
      if (n.includes("lanche") || n.includes("burger") || n.includes("hamb")) return "üçî";
      if (n.includes("acai") || n.includes("a√ßai")) return "üçß";
      if (n.includes("bebida") || n.includes("suco") || n.includes("refr")) return "ü•§";
      if (n.includes("sobrem")) return "üç∞";
      if (n.includes("extra")) return "üçü";
      return "üè∑Ô∏è";
    }

    let categories = loadCategories();

    function getCategoryLabel(id){
      const c = categories.find(x => x.id === id);
      if (!c) return "Produtos";
      return `${c.emoji || "üè∑Ô∏è"} ${c.label}`;
    }

    function ensureActiveCategory(){
      if (!categories.find(c => c.id === activeCategory)){
        activeCategory = categories[0]?.id || "pizzas";
      }
    }

    function renderCategoryTabs(){
      if (!els.categoryTabs) return;
      ensureActiveCategory();
      if (activeCategory === "pizzas"){
        if (!pizzaSubcats.includes(activePizzaSubcat)) activePizzaSubcat = pizzaSubcats[0];
      }

      const catChips = categories.map(c => `
        <div class="chip ${c.id === activeCategory ? "active" : ""}" data-cat="${c.id}">
          ${escapeHtml(c.emoji || "üè∑Ô∏è")} ${escapeHtml(c.label)}
        </div>
      `).join("");

      const subChips = (activeCategory === "pizzas") ? pizzaSubcats.map(sc => `
        <div class="chip ${sc === activePizzaSubcat ? "active":""}" data-subcat="${sc}">
          ${prettySubcat(sc)}
        </div>
      `).join("") : "";

      els.categoryTabs.innerHTML = catChips + subChips;
    }

    function renderCategorySelect(){
      if (!els.pCategory) return;
      els.pCategory.innerHTML = categories.map(c =>
        `<option value="${c.id}">${escapeHtml(c.emoji || "üè∑Ô∏è")} ${escapeHtml(c.label)}</option>`
      ).join("");
    }

    function categoryInUse(id){
      return products.some(p => p.category === id);
    }

    function renderCategoryEditor(){
      if (!els.categoryList) return;
      if (!categories.length){
        els.categoryList.innerHTML = `<div class="opsEmpty">Nenhuma categoria</div>`;
        return;
      }
      els.categoryList.innerHTML = categories.map(c => `
        <div class="catRow" data-id="${escapeAttr(c.id)}">
          <div class="catPreview">${escapeHtml(c.emoji || "üè∑Ô∏è")}</div>
          <input type="text" data-field="label" value="${escapeAttr(c.label)}" placeholder="Nome da categoria" />
          <input type="text" data-field="emoji" value="${escapeAttr(c.emoji || "")}" placeholder="Emoji" />
          <button class="miniBtn danger" type="button" data-action="del" data-id="${escapeAttr(c.id)}">Excluir</button>
        </div>
      `).join("");
    }

    const CATEGORY_EMOJIS = [
      "üçï","üçî","ü•™","üå≠","üçü","ü•ü","üçó","üçñ","ü•©","üç§",
      "üçù","üçõ","üçú","üç≤","ü•ó","ü•£","üßÄ","ü•ì","üç≥","ü•ö",
      "üçû","ü•ê","ü•ñ","ü´ì","ü•®","ü•Ø","üç∞","üßÅ","üç©","üç™",
      "üç´","üç¨","üç≠","üç¶","üç®","üçß","üçÆ","ü•ß","üçì","üçç",
      "üçá","üçå","üçâ","üçë","üçí","üçé","üçê","ü•≠","üçã","ü•ù",
      "ü•§","üßÉ","‚òï","ü´ñ","ü•õ","üç∫","üçπ","üßã","üßâ","üßä"
    ];

    function renderEmojiGrid(){
      if (!els.emojiGrid) return;
      els.emojiGrid.innerHTML = CATEGORY_EMOJIS.map(e => `
        <button class="emojiBtn" type="button" data-emoji="${escapeAttr(e)}">${escapeHtml(e)}</button>
      `).join("");
    }

    function openCategoryModal(){
      if (!els.categoryModal) return;
      if (!requireManager()) return;
      closeOtherModals();
      applyRoleLocks();
      renderCategoryEditor();
      els.categoryModal.style.display = "flex";
    }

    let emojiTargetInput = null;
    function openEmojiModal(targetInput){
      if (!els.emojiModal) return;
      emojiTargetInput = targetInput || null;
      renderEmojiGrid();
      els.emojiModal.style.display = "flex";
    }
    function closeEmojiModal(){
      if (els.emojiModal) els.emojiModal.style.display = "none";
    }

    function closeCategoryModal(){
      if (els.categoryModal) els.categoryModal.style.display = "none";
    }

    function saveCategoryEdits(){
      if (!els.categoryList) return;
      const rows = Array.from(els.categoryList.querySelectorAll(".catRow"));
      const updated = [];
      for (const row of rows){
        const id = row.dataset.id;
        const label = row.querySelector('[data-field="label"]')?.value?.trim() || "";
        const emoji = row.querySelector('[data-field="emoji"]')?.value?.trim() || "üè∑Ô∏è";
        if (!label){
          toast("Nome da categoria n√£o pode ficar vazio.", "error");
          return false;
        }
        updated.push({ id, label, emoji });
      }
      categories = updated;
      saveCategories(categories);
      renderCategoryTabs();
      renderCategorySelect();
      syncTabs();
      renderProducts();
      toast("Categorias atualizadas.", "success");
      return true;
    }

    // ===== Produtos =====
    const LS_KEY = "mvs_products_v3";
    function seedProducts(){
      return [
        { id: uid(), name:"Calabresa", category:"pizzas", emoji:"üçï", desc:"Tradicional", priceP:39.90, priceM:49.90, priceG:59.90, isKitchen:true },
        { id: uid(), name:"Frango c/ Catupiry", category:"pizzas", emoji:"üçï", desc:"Cremosa", priceP:42.90, priceM:54.90, priceG:64.90, isKitchen:true },
        { id: uid(), name:"4 Queijos", category:"pizzas", emoji:"üßÄ", desc:"Bem queijo", priceP:45.90, priceM:58.90, priceG:68.90, isKitchen:true },

        { id: uid(), name:"Refrigerante 2L", category:"bebidas", emoji:"ü•§", desc:"Gelado", price:12.00, isKitchen:false },
        { id: uid(), name:"Suco 500ml", category:"bebidas", emoji:"üßÉ", desc:"Natural", price:8.00, isKitchen:false },

        { id: uid(), name:"Borda Recheada", category:"extras", emoji:"üßÄ", desc:"Catupiry/Cheddar", price:8.00, isKitchen:true },
        { id: uid(), name:"Batata Frita", category:"extras", emoji:"üçü", desc:"Crocante", price:18.00, isKitchen:true },

        { id: uid(), name:"Brownie", category:"sobremesas", emoji:"üç∞", desc:"Top!", price:14.00, isKitchen:false },
      ];
    }

    function loadProducts(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if (!raw){
          const seeded = seedProducts();
          localStorage.setItem(LS_KEY, JSON.stringify(seeded));
          return seeded;
        }
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) throw new Error("bad");
        return parsed;
      }catch{
        const seeded = seedProducts();
        localStorage.setItem(LS_KEY, JSON.stringify(seeded));
        return seeded;
      }
    }

    function saveProducts(list){
      localStorage.setItem(LS_KEY, JSON.stringify(list));
    }

    let products = loadProducts();

    function prettyCatLabel(id){
      return String(id || "")
        .replace(/[-_]+/g, " ")
        .replace(/\b\w/g, (m) => m.toUpperCase());
    }

    function ensureCategoriesFromProducts(){
      let changed = false;
      for (const p of products){
        const cid = String(p.category || "").trim();
        if (!cid) continue;
        if (!categories.find(c => c.id === cid)){
          categories.push({
            id: cid,
            label: prettyCatLabel(cid),
            emoji: guessCategoryEmoji(cid)
          });
          changed = true;
        }
      }
      if (changed) saveCategories(categories);
    }

    // ===== Carrinho =====
    // cart: Map<key, { name, qty, unit_price, notes, is_kitchen, emoji }>
    const cart = new Map();

    // ===== UI/DOM =====
    const els = {
      clock: document.getElementById("clock"),
      systemBtn: document.getElementById("systemBtn"),
      systemModal: document.getElementById("systemModal"),
      systemClose: document.getElementById("systemClose"),
      rolePill: document.getElementById("rolePill"),
      roleText: document.getElementById("roleText"),
      roleDot: document.getElementById("roleDot"),

      managerPinInput: document.getElementById("managerPinInput"),
      managerLoginBtn: document.getElementById("managerLoginBtn"),
      managerLogoutBtn: document.getElementById("managerLogoutBtn"),
      managerNewPinInput: document.getElementById("managerNewPinInput"),
      managerSetPinBtn: document.getElementById("managerSetPinBtn"),
      backupExportBtn: document.getElementById("backupExportBtn"),
      backupImportBtn: document.getElementById("backupImportBtn"),
      backupFileInput: document.getElementById("backupFileInput"),
      backupHint: document.getElementById("backupHint"),
      diagInfo: document.getElementById("diagInfo"),
      diagRefreshBtn: document.getElementById("diagRefreshBtn"),
      logClearBtn: document.getElementById("logClearBtn"),
      logList: document.getElementById("logList"),
      categoryTabs: document.getElementById("categoryTabs"),
      activeCategoryLabel: document.getElementById("activeCategoryLabel"),
      searchInput: document.getElementById("searchInput"),
      products: document.getElementById("products"),
      productsTitle: document.getElementById("productsTitle"),

      importXmlBtn: document.getElementById("importXmlBtn"),
      xmlFileInput: document.getElementById("xmlFileInput"),

      cartItems: document.getElementById("cartItems"),
      emptyState: document.getElementById("emptyState"),
      subtotal: document.getElementById("subtotal"),
      discount: document.getElementById("discount"),
      fee: document.getElementById("fee"),
      total: document.getElementById("total"),

      finishBtn: document.getElementById("finishBtn"),
      clearBtn: document.getElementById("clearBtn"),

      cashPill: document.getElementById("cashPill"),
      cashDot: document.getElementById("cashDot"),
      cashText: document.getElementById("cashText"),

      reportsBtn: document.getElementById("reportsBtn"),
      reportsModal: document.getElementById("reportsModal"),
      reportsClose: document.getElementById("reportsClose"),
      reportDate: document.getElementById("reportDate"),
      reportGrid: document.getElementById("reportGrid"),

      metaType: document.getElementById("metaType"),
      metaPay: document.getElementById("metaPay"),

      // Product modal
      productModal: document.getElementById("productModal"),
      productModalTitle: document.getElementById("productModalTitle"),
      productClose: document.getElementById("productClose"),
      productCancel: document.getElementById("productCancel"),
      productSave: document.getElementById("productSave"),
      newProductBtn: document.getElementById("newProductBtn"),
      manageCategoriesBtn: document.getElementById("manageCategoriesBtn"),
      pName: document.getElementById("pName"),
      pCategory: document.getElementById("pCategory"),
      pSubcat: document.getElementById("pSubcat"),
      pEmoji: document.getElementById("pEmoji"),
      pDesc: document.getElementById("pDesc"),
      pPrice: document.getElementById("pPrice"),
      pPriceP: document.getElementById("pPriceP"),
      pPriceM: document.getElementById("pPriceM"),
      pPriceG: document.getElementById("pPriceG"),
      priceSingleBlock: document.getElementById("priceSingleBlock"),
      pricePizzaBlock: document.getElementById("pricePizzaBlock"),
      kitchenBlock: document.getElementById("kitchenBlock"),
      pIsKitchen: document.getElementById("pIsKitchen"),
      pIsKitchenPizza: document.getElementById("pIsKitchenPizza"),

      // Pizza modal
      pizzaModal: document.getElementById("pizzaModal"),
      pizzaTitle: document.getElementById("pizzaTitle"),
      pizzaClose: document.getElementById("pizzaClose"),
      pizzaCancel: document.getElementById("pizzaCancel"),
      sizeSeg: document.getElementById("sizeSeg"),
      halfSeg: document.getElementById("halfSeg"),
      flavor1: document.getElementById("flavor1"),
      flavor2: document.getElementById("flavor2"),
      pizzaNotes: document.getElementById("pizzaNotes"),
      pizzaPrice: document.getElementById("pizzaPrice"),
      pizzaAdd: document.getElementById("pizzaAdd"),

      // Checkout modal
      checkoutModal: document.getElementById("checkoutModal"),
      checkoutClose: document.getElementById("checkoutClose"),
      checkoutCancel: document.getElementById("checkoutCancel"),
      checkoutConfirm: document.getElementById("checkoutConfirm"),
      orderType: document.getElementById("orderType"),
      tableNo: document.getElementById("tableNo"),
      custName: document.getElementById("custName"),
      custPhone: document.getElementById("custPhone"),
      custAddress: document.getElementById("custAddress"),
      orderNotes: document.getElementById("orderNotes"),
      paymentMethod: document.getElementById("paymentMethod"),
      paymentBlock: document.getElementById("paymentBlock"),
      paymentRow: document.getElementById("paymentRow"),
      checkoutTotal: document.getElementById("checkoutTotal"),

      // Mesas/Cozinha
      opsBtn: document.getElementById("opsBtn"),
      opsModal: document.getElementById("opsModal"),
      opsClose: document.getElementById("opsClose"),
      opsRefresh: document.getElementById("opsRefresh"),
      opsTables: document.getElementById("opsTables"),
      opsKitchen: document.getElementById("opsKitchen"),

      // Category modal
      categoryModal: document.getElementById("categoryModal"),
      categoryClose: document.getElementById("categoryClose"),
      categoryCancel: document.getElementById("categoryCancel"),
      categorySave: document.getElementById("categorySave"),
      categoryAddBtn: document.getElementById("categoryAddBtn"),
      categoryList: document.getElementById("categoryList"),
      categoryAddName: document.getElementById("categoryAddName"),
      categoryAddEmoji: document.getElementById("categoryAddEmoji"),
      categoryEmojiToggle: document.getElementById("categoryEmojiToggle"),
      emojiModal: document.getElementById("emojiModal"),
      emojiClose: document.getElementById("emojiClose"),
      emojiGrid: document.getElementById("emojiGrid"),
    };

    let activeCategory = "pizzas";
    let searchQuery = "";
    let editingProductId = null;
    let closingTableId = null;

    // ===== Rel√≥gio =====
    function tickClock(){
      const d = new Date();
      const hh = String(d.getHours()).padStart(2,"0");
      const mm = String(d.getMinutes()).padStart(2,"0");
      els.clock.textContent = `${hh}:${mm}`;
    }
    tickClock(); setInterval(tickClock, 1000);

    function todayISODate(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }

    // ===== Caixa UI =====
    function renderShift(){
      if (shiftState.open){
        els.cashText.textContent = "Caixa: ABERTO";
        els.cashDot.classList.remove("closed");
      } else {
        els.cashText.textContent = "Caixa: FECHADO";
        els.cashDot.classList.add("closed");
      }
    }
    renderShift();
    syncCashFromServer();

    // ===== Mesas/Cozinha =====
    let opsPoll = null;

    function prettyType(t){
      const v = String(t || "");
      return v ? (v.charAt(0).toUpperCase() + v.slice(1)) : "-";
    }

    function fmtDateTime(iso){
      try{ return new Date(iso).toLocaleString("pt-BR"); }
      catch{ return "-"; }
    }

    function renderOpsTables(rows){
      if (!rows || rows.length === 0){
        els.opsTables.innerHTML = `<div class="opsEmpty">Nenhuma mesa aberta</div>`;
        return;
      }

      els.opsTables.innerHTML = rows.map(r => {
        const mesa = r.table_no ? `Mesa ${escapeHtml(r.table_no)}` : "Mesa";
        const total = brl(Number(r.total || 0));
        return `
          <div class="opsItem">
            <div>
              <div class="opsTitle">#${escapeHtml(String(r.order_number || "-"))} ‚Ä¢ ${mesa}</div>
              <div class="opsMeta">${escapeHtml(fmtDateTime(r.created_at))} ‚Ä¢ Total ${escapeHtml(total)}</div>
            </div>
            <button class="miniBtn" type="button" data-action="close-table" data-id="${escapeHtml(String(r.id))}">Fechar mesa</button>
          </div>
        `;
      }).join("");
    }

    function renderOpsKitchen(rows){
      if (!rows || rows.length === 0){
        els.opsKitchen.innerHTML = `<div class="opsEmpty">Nenhum item pendente</div>`;
        return;
      }

      els.opsKitchen.innerHTML = rows.map(r => {
        const qtyName = `${r.qty}x ${r.name}`;
        const origin = (String(r.order_type) === "mesa" && r.table_no)
          ? `Mesa ${r.table_no}`
          : prettyType(r.order_type);
        const notes = (r.notes || "").trim();
        const meta = `Pedido #${r.order_number} ‚Ä¢ ${origin} ‚Ä¢ ${fmtDateTime(r.created_at)}`;
        return `
          <div class="opsItem">
            <div>
              <div class="opsTitle">${escapeHtml(qtyName)}</div>
              <div class="opsMeta">${escapeHtml(meta)}</div>
              ${notes ? `<div class="opsMeta">Obs: ${escapeHtml(notes)}</div>` : ""}
            </div>
            <button class="miniBtn" type="button" data-action="ready-item" data-id="${escapeHtml(String(r.id))}">Pronto</button>
          </div>
        `;
      }).join("");
    }

    async function loadOpsData(){
      if (!els.opsTables || !els.opsKitchen) return;

      try{
        setButtonLoading(els.opsRefresh, true);
        const [tResp, kResp] = await Promise.all([
          fetch("/api/tables/open"),
          fetch("/api/kitchen/pending"),
        ]);

        const tData = await tResp.json().catch(() => null);
        const kData = await kResp.json().catch(() => null);

        if (!tResp.ok || tData?.ok === false) throw new Error(tData?.error || "Erro ao carregar mesas");
        if (!kResp.ok || kData?.ok === false) throw new Error(kData?.error || "Erro ao carregar cozinha");

        renderOpsTables(tData?.rows || []);
        renderOpsKitchen(kData?.rows || []);
      } catch (e){
        els.opsTables.innerHTML = `<div class="opsEmpty">Falha ao carregar mesas</div>`;
        els.opsKitchen.innerHTML = `<div class="opsEmpty">Falha ao carregar cozinha</div>`;
        logError("Falha ao carregar OPS", e);
      } finally {
        setButtonLoading(els.opsRefresh, false);
      }
    }

    async function loadTableToCart(orderId){
      try{
        const resp = await fetch(`/api/orders/${orderId}`);
        const data = await resp.json().catch(() => null);
        if (!resp.ok || data?.ok === false) throw new Error(data?.error || "Erro ao carregar mesa");

        const order = data.order || {};
        const items = Array.isArray(data.items) ? data.items : [];

        cart.clear();
        for (const it of items){
          const key = `orderitem|${it.id}`;
          cart.set(key, {
            name: String(it.name || "Item"),
            qty: Number(it.qty || 1),
            unit_price: Number(it.unit_price || 0),
            notes: String(it.notes || ""),
            is_kitchen: !!it.is_kitchen,
            emoji: "üßæ"
          });
        }

        renderCart();

        closingTableId = Number(order.id || orderId);
        els.orderType.value = order.order_type || "mesa";
        els.tableNo.value = order.table_no || "";
        els.custName.value = order.customer_name || "";
        els.custPhone.value = order.customer_phone || "";
        els.custAddress.value = order.address || "";
        els.orderNotes.value = order.notes || "";

        els.orderType.dispatchEvent(new Event("change"));
        updatePaymentVisibility();

        closeOpsModal();
        toast("Mesa carregada no carrinho. Finalize o pagamento.", "success");
      } catch (e){
        toast("Falha ao carregar mesa: " + e.message, "error", { detail: e?.stack || e?.message });
      }
    }

    function openOpsModal(){
      els.opsModal.style.display = "flex";
      loadOpsData();
      if (opsPoll) clearInterval(opsPoll);
      opsPoll = setInterval(loadOpsData, 8000);
    }

    function closeOpsModal(){
      els.opsModal.style.display = "none";
      if (opsPoll) { clearInterval(opsPoll); opsPoll = null; }
    }

    els.opsBtn.addEventListener("click", openOpsModal);
    els.opsClose.addEventListener("click", closeOpsModal);
    els.opsRefresh.addEventListener("click", loadOpsData);
    els.opsModal.addEventListener("click", (e) => { if (e.target === els.opsModal) closeOpsModal(); });

    els.opsTables.addEventListener("click", async (e) => {
      const btn = e.target.closest("button[data-action='close-table']");
      if (!btn) return;
      const id = btn.dataset.id;
      if (!confirm("Carregar mesa no carrinho para fechar?")) return;
      setButtonLoading(btn, true);
      try{
        await loadTableToCart(id);
      } finally {
        setButtonLoading(btn, false);
      }
    });

    els.opsKitchen.addEventListener("click", async (e) => {
      const btn = e.target.closest("button[data-action='ready-item']");
      if (!btn) return;
      const id = btn.dataset.id;
      try{
        setButtonLoading(btn, true);
        const resp = await fetch(`/api/kitchen/item/${id}/ready`, { method:"POST" });
        const data = await resp.json().catch(() => null);
        if (!resp.ok || data?.ok === false) throw new Error(data?.error || "Erro ao atualizar item");
        loadOpsData();
      } catch (err){
        toast("Falha ao marcar pronto: " + err.message, "error", { detail: err?.stack || err?.message });
      } finally {
        setButtonLoading(btn, false);
      }
    });

    // ===== Relat√≥rios =====
    function openReportsModal(){
      if (!els.reportsModal) return;
      if (!requireManager()) return;
      closeOtherModals();
      if (els.reportDate && !els.reportDate.value) {
        els.reportDate.value = todayISODate();
      }
      els.reportsModal.style.display = "flex";
    }

    function closeReportsModal(){
      if (els.reportsModal) els.reportsModal.style.display = "none";
    }

    if (els.reportsBtn) els.reportsBtn.addEventListener("click", openReportsModal);
    if (els.reportsClose) els.reportsClose.addEventListener("click", closeReportsModal);
    if (els.reportsModal) els.reportsModal.addEventListener("click", (e) => {
      if (e.target === els.reportsModal) closeReportsModal();
    });

    if (els.reportGrid) els.reportGrid.addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-report]");
      if (!btn) return;
      const period = btn.dataset.report;

      if (period === "last"){
        window.open("/api/cash/report/print", "_blank");
        return;
      }

      const date = (els.reportDate && els.reportDate.value) ? els.reportDate.value : todayISODate();
      const qs = new URLSearchParams({ period, date }).toString();
      window.open(`/api/reports/print?${qs}`, "_blank");
    });

    // ===== Sistema / Diagn√≥stico =====
    function renderLogs(){
      if (!els.logList) return;
      if (!logs.length){
        els.logList.innerHTML = `<div class="logRow"><div class="logMsg">Sem logs no momento</div></div>`;
        return;
      }

      const rows = [...logs].reverse().slice(0, 200).map(l => {
        const when = new Date(l.ts).toLocaleString("pt-BR");
        return `
          <div class="logRow">
            <div class="logMeta">
              <span>${escapeHtml(l.level.toUpperCase())}</span>
              <span>${escapeHtml(when)}</span>
            </div>
            <div class="logMsg">${escapeHtml(l.msg)}${l.data ? ` ‚Ä¢ ${escapeHtml(l.data)}` : ""}</div>
          </div>
        `;
      }).join("");
      els.logList.innerHTML = rows;
    }

    function formatBytes(bytes){
      const b = Number(bytes || 0);
      if (b < 1024) return `${b} B`;
      const kb = b / 1024;
      if (kb < 1024) return `${kb.toFixed(1)} KB`;
      const mb = kb / 1024;
      if (mb < 1024) return `${mb.toFixed(1)} MB`;
      const gb = mb / 1024;
      return `${gb.toFixed(2)} GB`;
    }

    async function loadDiagnostics(){
      if (!els.diagInfo) return;
      setButtonLoading(els.diagRefreshBtn, true);
      try{
        const resp = await fetch("/api/diag");
        const data = await resp.json().catch(() => null);
        if (!resp.ok || data?.ok === false) throw new Error(data?.error || "Erro");

        const lines = [
          `Vers√£o: ${data?.app?.version || "-"}`,
          `Node: ${data?.app?.node || "-"}`,
          `Plataforma: ${data?.app?.platform || "-"} / ${data?.app?.arch || "-"}`,
          `Uptime: ${Math.round(Number(data?.app?.uptime || 0))}s`,
          `DB: ${data?.db?.path || "-"}`,
          `DB tamanho: ${formatBytes(data?.db?.size || 0)}`,
          `Pedidos: ${data?.db?.orders ?? "-"}`,
          `Itens: ${data?.db?.items ?? "-"}`,
          `Caixa: ${data?.db?.cash_status || "-"}`,
          `√öltimo backup: ${data?.db?.last_backup_at ? new Date(data.db.last_backup_at).toLocaleString("pt-BR") : "-"}`
        ];

        els.diagInfo.textContent = lines.join("\n");
        if (els.backupHint){
          const lastBk = data?.db?.last_backup_at
            ? new Date(data.db.last_backup_at).toLocaleString("pt-BR")
            : "‚Äî";
          els.backupHint.textContent = `Backup autom√°tico ativo. √öltimo: ${lastBk}`;
        }
      } catch (e){
        toast("Falha ao carregar diagn√≥stico: " + e.message, "error", { detail: e?.stack || e?.message });
      } finally {
        setButtonLoading(els.diagRefreshBtn, false);
      }
    }

    function openSystemModal(){
      if (!els.systemModal) return;
      closeOtherModals();
      renderLogs();
      loadDiagnostics();
      els.systemModal.style.display = "flex";
    }

    function closeSystemModal(){
      if (els.systemModal) els.systemModal.style.display = "none";
    }

    if (els.systemBtn) els.systemBtn.addEventListener("click", openSystemModal);
    if (els.systemClose) els.systemClose.addEventListener("click", closeSystemModal);
    if (els.systemModal) els.systemModal.addEventListener("click", (e) => {
      if (e.target === els.systemModal) closeSystemModal();
    });
    if (els.rolePill) els.rolePill.addEventListener("click", () => {
      openSystemModal();
      setTimeout(() => els.managerPinInput?.focus(), 0);
    });

    if (els.managerLoginBtn) els.managerLoginBtn.addEventListener("click", () => {
      const pin = String(els.managerPinInput?.value || "").trim();
      if (!pin){
        toast("Informe o PIN do gerente.", "error");
        return;
      }
      if (pin !== managerPin){
        toast("PIN inv√°lido.", "error");
        return;
      }
      setRole("gerente");
      toast("Modo gerente ativado.", "success");
      if (els.managerPinInput) els.managerPinInput.value = "";
    });
    if (els.managerPinInput) els.managerPinInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") els.managerLoginBtn?.click();
    });

    if (els.managerLogoutBtn) els.managerLogoutBtn.addEventListener("click", () => {
      setRole("operador");
      toast("Modo operador ativado.", "info");
    });

    if (els.managerSetPinBtn) els.managerSetPinBtn.addEventListener("click", () => {
      if (!requireManager()) return;
      const newPin = String(els.managerNewPinInput?.value || "").trim();
      if (newPin.length < 4){
        toast("PIN deve ter no m√≠nimo 4 d√≠gitos.", "error");
        return;
      }
      managerPin = newPin;
      localStorage.setItem(LS_MANAGER_PIN, managerPin);
      if (els.managerNewPinInput) els.managerNewPinInput.value = "";
      toast("PIN atualizado com sucesso.", "success");
    });
    if (els.managerNewPinInput) els.managerNewPinInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") els.managerSetPinBtn?.click();
    });

    if (els.backupExportBtn) els.backupExportBtn.addEventListener("click", async () => {
      if (!requireManager()) return;
      setButtonLoading(els.backupExportBtn, true);
      try{
        const resp = await fetch("/api/backup/export");
        if (!resp.ok) throw new Error("Falha ao exportar backup");
        const blob = await resp.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        const stamp = new Date().toISOString().replace(/[:.]/g,"-");
        a.href = url;
        a.download = window.__MVS_DEMO_STORAGE
          ? `mvs_pdv_backup_demo_${stamp}.json`
          : `mvs_pdv_backup_${stamp}.sqlite`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        toast("Backup exportado.", "success");
        loadDiagnostics();
      } catch (e){
        toast("Falha ao exportar: " + e.message, "error", { detail: e?.stack || e?.message });
      } finally {
        setButtonLoading(els.backupExportBtn, false);
      }
    });

    if (els.backupImportBtn) els.backupImportBtn.addEventListener("click", () => {
      if (!requireManager()) return;
      if (els.backupFileInput){
        els.backupFileInput.value = "";
        els.backupFileInput.click();
      }
    });

    if (els.backupFileInput) els.backupFileInput.addEventListener("change", async () => {
      const file = els.backupFileInput.files?.[0];
      if (!file) return;
      if (!requireManager()) return;
      setButtonLoading(els.backupImportBtn, true);
      try{
        const buf = await file.arrayBuffer();
        const resp = await fetch("/api/backup/import", {
          method:"POST",
          headers:{ "Content-Type":"application/octet-stream" },
          body: buf
        });
        const data = await resp.json().catch(() => null);
        if (!resp.ok || data?.ok === false) throw new Error(data?.error || "Erro ao importar");
        toast("Backup importado. Reabra o app para garantir consist√™ncia.", "success");
        loadDiagnostics();
      } catch (e){
        toast("Falha ao importar: " + e.message, "error", { detail: e?.stack || e?.message });
      } finally {
        setButtonLoading(els.backupImportBtn, false);
      }
    });

    if (els.diagRefreshBtn) els.diagRefreshBtn.addEventListener("click", loadDiagnostics);
    if (els.logClearBtn) els.logClearBtn.addEventListener("click", () => {
      if (!requireManager()) return;
      logs = [];
      saveLogs();
      renderLogs();
      toast("Logs limpos.", "success");
    });

    // ===== Tabs + Busca =====
    function syncTabs(){
      ensureActiveCategory();
      renderCategoryTabs();
      if (els.activeCategoryLabel) {
        els.activeCategoryLabel.textContent = getCategoryLabel(activeCategory);
      }
      if (els.productsTitle) {
        els.productsTitle.style.display = (activeCategory === "pizzas") ? "block" : "none";
      }
    }

    els.categoryTabs.addEventListener("click", (e) => {
      const sub = e.target.closest(".chip[data-subcat]");
      if (sub){
        activePizzaSubcat = sub.dataset.subcat;
        renderCategoryTabs();
        renderProducts();
        return;
      }
      const chip = e.target.closest(".chip[data-cat]");
      if (!chip) return;
      activeCategory = chip.dataset.cat;
      syncTabs();
      renderProducts();
    });

    els.searchInput.addEventListener("input", () => {
      searchQuery = els.searchInput.value;
      renderProducts();
    });

    // ===== Render Produtos =====
    function filteredProducts(){
      ensureActiveCategory();
      const q = searchQuery.trim().toLowerCase();
      return products.filter(p => {
        if (p.category !== activeCategory) return false;
        if (p.category === "pizzas"){
          const activeSub = normalizeSubcat(activePizzaSubcat) || defaultPizzaSubcat();
          if (productSubcat(p) !== activeSub) return false;
        }
        if (!q) return true;
        const hay = `${p.name} ${p.desc || ""}`.toLowerCase();
        return hay.includes(q);
      });
    }

    function productMainPrice(p){
      if (p.category === "pizzas"){
        const min = Math.min(Number(p.priceP||0), Number(p.priceM||0), Number(p.priceG||0));
        return `a partir de ${brl(min)}`;
      }
      return brl(Number(p.price || 0));
    }

    function renderProducts(){
      ensureActiveCategory();
      if (els.activeCategoryLabel) {
        els.activeCategoryLabel.textContent = getCategoryLabel(activeCategory);
      }
      const list = filteredProducts();

      if (list.length === 0){
        els.products.innerHTML = `<div class="emptyState" style="grid-column:1/-1">Nada aqui üòÖ</div>`;
        return;
      }

      els.products.innerHTML = list.map(p => `
        <article class="prod" data-id="${escapeHtml(p.id)}">
          <div class="inner">
            <h3>${escapeHtml(p.emoji || "üßæ")} ${escapeHtml(p.name)}</h3>
            <div class="priceRow">
              <div>
                <div class="price">${productMainPrice(p)}</div>
                <div class="mini">${escapeHtml(p.desc || "")}</div>
              </div>
              <button class="add" type="button" data-action="add"><span>‚ûï</span>Adicionar</button>
            </div>
            <div class="prodActions">
              <button class="miniBtn" type="button" data-action="edit" data-role-only="manager">‚úèÔ∏è Editar</button>
              <button class="miniBtn danger" type="button" data-action="del" data-role-only="manager">üóëÔ∏è Excluir</button>
            </div>
          </div>
        </article>
      `).join("");

      applyRoleLocks();
    }

    // ===== Render Carrinho =====
    function renderCart(){
      const isEmpty = cart.size === 0;
      els.emptyState.style.display = isEmpty ? "block" : "none";

      const nodes = Array.from(els.cartItems.querySelectorAll('[data-cart-row="1"]'));
      nodes.forEach(n => n.remove());

      for (const [key, item] of cart.entries()){
        const row = document.createElement("div");
        row.className = "item";
        row.dataset.cartRow = "1";
        row.dataset.key = key;

        const noteLine = (item.notes || "").trim();
        const unitLine = `${brl(item.unit_price)} ‚Ä¢ ${item.qty}x`;

        row.innerHTML = `
          <div class="emoji">${escapeHtml(item.emoji || "üßæ")}</div>
          <div>
            <h4>${escapeHtml(item.name)}</h4>
            <p>${escapeHtml(noteLine || unitLine)}</p>
          </div>
          <div class="qty">
            <button type="button" data-action="dec">‚àí</button>
            <span>${item.qty}</span>
            <button type="button" data-action="inc">+</button>
          </div>
        `;
        els.cartItems.appendChild(row);
      }

      renderTotals();
    }

    function renderTotals(){
      let subtotal = 0;
      for (const it of cart.values()){
        subtotal += it.unit_price * it.qty;
      }
      const discount = 0;
      const fee = 0;
      const total = Math.max(0, subtotal - discount + fee);

      els.subtotal.textContent = brl(subtotal);
      els.discount.textContent = brl(discount);
      els.fee.textContent = brl(fee);
      els.total.textContent = brl(total);
    }

    // ===== Carrinho +/‚àí =====
    els.cartItems.addEventListener("click", (e) => {
      if (closingTableId){
        toast("Mesa em fechamento. Para alterar itens, cancele o fechamento e abra uma nova venda.", "info");
        return;
      }
      const b = e.target.closest("button[data-action]");
      if (!b) return;
      const row = e.target.closest("[data-cart-row='1']");
      if (!row) return;

      const key = row.dataset.key;
      const it = cart.get(key);
      if (!it) return;

      if (b.dataset.action === "inc") it.qty += 1;
      if (b.dataset.action === "dec") it.qty -= 1;

      if (it.qty <= 0) cart.delete(key);
      renderCart();
    });

    els.clearBtn.addEventListener("click", () => {
      if (closingTableId){
        const ok = confirm("Cancelar fechamento da mesa e limpar carrinho?");
        if (!ok) return;
        closingTableId = null;
        updatePaymentVisibility();
      }
      cart.clear();
      renderCart();
    });

    // ===== Produto Modal (Cadastrar/Editar) =====
    function openProductModal(mode, product){
      els.productModal.style.display = "flex";
      ensureCategoriesFromProducts();
      renderCategorySelect();
      ensureActiveCategory();

      if (mode === "edit"){
        editingProductId = product.id;
        els.productModalTitle.textContent = "Editar Produto";
        els.pName.value = product.name || "";
        els.pCategory.value = product.category || "pizzas";
        els.pEmoji.value = product.emoji || "";
        els.pDesc.value = product.desc || "";
        els.pIsKitchen.value = product.isKitchen ? "1" : "0";
        els.pIsKitchenPizza.value = product.isKitchen ? "1" : "0";

        if (product.category === "pizzas"){
          els.pPriceP.value = String(product.priceP ?? "").replace(".", ",");
          els.pPriceM.value = String(product.priceM ?? "").replace(".", ",");
          els.pPriceG.value = String(product.priceG ?? "").replace(".", ",");
        } else {
          els.pPrice.value = String(product.price ?? "").replace(".", ",");
        }
      } else {
        editingProductId = null;
        els.productModalTitle.textContent = "Cadastrar Produto";
        els.pName.value = "";
        els.pCategory.value = activeCategory;
        els.pEmoji.value = "";
        els.pDesc.value = "";
        els.pPrice.value = "";
        els.pPriceP.value = "";
        els.pPriceM.value = "";
        els.pPriceG.value = "";
        els.pIsKitchen.value = "1";
        els.pIsKitchenPizza.value = "1";
      }

      syncPriceBlocks();
      if (els.pCategory.value === "pizzas"){
        const subcat = (mode === "edit")
          ? (product?.subcat || activePizzaSubcat || pizzaSubcats[0])
          : (activePizzaSubcat || pizzaSubcats[0]);
        if (subcat) els.pSubcat.value = subcat;
      }
      setTimeout(() => els.pName.focus(), 0);
    }

    function closeProductModal(){
      els.productModal.style.display = "none";
    }

    function syncPriceBlocks(){
      const isPizza = els.pCategory.value === "pizzas";
      els.priceSingleBlock.style.display = isPizza ? "none" : "grid";
      els.pricePizzaBlock.style.display = isPizza ? "block" : "none";
      els.kitchenBlock.style.display = isPizza ? "none" : "grid";
      syncSubcatSelect();
    }

    els.pCategory.addEventListener("change", syncPriceBlocks);

    els.newProductBtn.addEventListener("click", () => {
      if (!requireManager()) return;
      openProductModal("new");
    });
    function addCategoryPrompt(){
      if (!requireManager()) return;
      const name = String(els.categoryAddName?.value || "").trim();
      if (!name){
        toast("Informe o nome da categoria.", "error");
        els.categoryAddName?.focus();
        return;
      }

      const id = normalizeCategoryId(name);
      if (!id){
        toast("Nome inv√°lido.", "error");
        return;
      }

      const emoji = String(els.categoryAddEmoji?.value || "").trim() || guessCategoryEmoji(name);

      const existing = categories.find(c => c.id === id);
      if (existing){
        existing.label = name;
        existing.emoji = emoji;
        toast("Categoria atualizada.", "success");
      } else {
        categories.push({ id, label: name, emoji });
        toast("Categoria adicionada.", "success");
      }

      saveCategories(categories);
      activeCategory = id;
      renderCategoryTabs();
      renderCategorySelect();
      syncTabs();
      renderProducts();
      renderCategoryEditor();
      if (els.productModal && els.productModal.style.display === "flex"){
        els.pCategory.value = id;
        syncPriceBlocks();
      }
      if (els.categoryAddName) els.categoryAddName.value = "";
      if (els.categoryAddEmoji) els.categoryAddEmoji.value = "";
      els.categoryAddName?.focus();
    }

    if (els.manageCategoriesBtn) els.manageCategoriesBtn.addEventListener("click", openCategoryModal);
    if (els.categoryClose) els.categoryClose.addEventListener("click", closeCategoryModal);
    if (els.categoryCancel) els.categoryCancel.addEventListener("click", closeCategoryModal);
    if (els.categoryModal) els.categoryModal.addEventListener("click", (e) => {
      if (e.target === els.categoryModal) closeCategoryModal();
    });
    if (els.categoryAddBtn) els.categoryAddBtn.addEventListener("click", addCategoryPrompt);
    if (els.categoryAddName) els.categoryAddName.addEventListener("keydown", (e) => {
      if (e.key === "Enter") addCategoryPrompt();
    });
    if (els.categoryAddEmoji) els.categoryAddEmoji.addEventListener("keydown", (e) => {
      if (e.key === "Enter") addCategoryPrompt();
    });
    if (els.categoryEmojiToggle) els.categoryEmojiToggle.addEventListener("click", (e) => {
      e.stopPropagation();
      openEmojiModal(els.categoryAddEmoji);
    });
    if (els.emojiClose) els.emojiClose.addEventListener("click", closeEmojiModal);
    if (els.emojiModal) els.emojiModal.addEventListener("click", (e) => {
      if (e.target === els.emojiModal) closeEmojiModal();
    });
    if (els.emojiGrid) els.emojiGrid.addEventListener("click", (e) => {
      const b = e.target.closest("button[data-emoji]");
      if (!b) return;
      if (emojiTargetInput){
        emojiTargetInput.value = b.dataset.emoji || "";
        emojiTargetInput.focus();
      }
      closeEmojiModal();
    });
    if (els.categorySave) els.categorySave.addEventListener("click", () => {
      if (!requireManager()) return;
      if (saveCategoryEdits()) closeCategoryModal();
    });
    if (els.categoryList) els.categoryList.addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-action='del']");
      if (!btn) return;
      if (!requireManager()) return;
      const id = btn.dataset.id;
      if (!id) return;
      if (categoryInUse(id)){
        toast("N√£o √© poss√≠vel excluir: categoria em uso.", "error");
        return;
      }
      if (!confirm("Excluir categoria?")) return;
      categories = categories.filter(c => c.id !== id);
      saveCategories(categories);
      renderCategoryEditor();
      renderCategoryTabs();
      renderCategorySelect();
      syncTabs();
      renderProducts();
      toast("Categoria removida.", "success");
    });
    els.productClose.addEventListener("click", closeProductModal);
    els.productCancel.addEventListener("click", closeProductModal);
    els.productModal.addEventListener("click", (e) => { if (e.target === els.productModal) closeProductModal(); });

    function upsertProduct(){
      if (!requireManager()) return;
      const name = els.pName.value.trim();
      const category = els.pCategory.value;
      const emoji = els.pEmoji.value.trim() || (
        category === "pizzas" ? "üçï" :
        category === "bebidas" ? "ü•§" :
        category === "sobremesas" ? "üç∞" : "üçü"
      );
      const desc = els.pDesc.value.trim();
      const isKitchen = (category === "pizzas")
        ? (els.pIsKitchenPizza.value === "1")
        : (els.pIsKitchen.value === "1");

      if (!name){
        toast("Informe o nome do produto.", "error");
        els.pName.focus();
        return;
      }

      let product;

      if (category === "pizzas"){
        const priceP = parsePrice(els.pPriceP.value);
        const priceM = parsePrice(els.pPriceM.value);
        const priceG = parsePrice(els.pPriceG.value);
        const subcat = normalizeSubcat(els.pSubcat?.value || activePizzaSubcat || pizzaSubcats[0]);

        if (![priceP, priceM, priceG].every(v => Number.isFinite(v) && v >= 0)){
          toast("Pre√ßos P/M/G inv√°lidos. Ex: 49,90", "error");
          return;
        }

        product = { name, category, emoji, desc, priceP, priceM, priceG, isKitchen, subcat };
      } else {
        const price = parsePrice(els.pPrice.value);
        if (!Number.isFinite(price) || price < 0){
          toast("Pre√ßo inv√°lido. Ex: 12,00", "error");
          return;
        }
        product = { name, category, emoji, desc, price, isKitchen };
      }

      if (editingProductId){
        products = products.map(p => p.id === editingProductId ? { ...p, ...product } : p);
      } else {
        products = [{ id: uid(), ...product }, ...products];
      }

      saveProducts(products);
      closeProductModal();

      activeCategory = category;
      syncTabs();
      renderProducts();
    }

    els.productSave.addEventListener("click", upsertProduct);

    function deleteProduct(id){
      if (!requireManager()) return;
      const p = products.find(x => x.id === id);
      if (!p) return;
      if (!confirm(`Excluir "${p.name}"?`)) return;

      products = products.filter(x => x.id !== id);
      saveProducts(products);

      for (const key of cart.keys()){
        if (key.startsWith("item|") && key.endsWith(id)) cart.delete(key);
      }

      renderProducts();
      renderCart();
    }

    // ===== Pizza Modal (PMG + meio a meio) =====
    let pizzaState = { size:"M", half:false, flavor1Id:null, flavor2Id:null, notes:"" };

    function setSegActive(segEl, attr, value){
      Array.from(segEl.querySelectorAll("button")).forEach(b => {
        b.classList.toggle("active", b.getAttribute(attr) === value);
      });
    }

    function priceForSize(pizzaProduct, size){
      if (size === "P") return Number(pizzaProduct.priceP || 0);
      if (size === "M") return Number(pizzaProduct.priceM || 0);
      return Number(pizzaProduct.priceG || 0);
    }

    function updatePizzaPrice(){
      const f1 = products.find(p => p.id === pizzaState.flavor1Id);
      const f2 = products.find(p => p.id === pizzaState.flavor2Id);
      if (!f1){ els.pizzaPrice.value = "‚Äî"; return; }

      const p1 = priceForSize(f1, pizzaState.size);

      if (!pizzaState.half){
        els.pizzaPrice.value = brl(p1);
        return;
      }

      const p2 = f2 ? priceForSize(f2, pizzaState.size) : p1;
      const final = Math.max(p1, p2);
      els.pizzaPrice.value = brl(final) + " (meio a meio)";
    }

    function openPizzaModal(defaultFlavorId){
      const pizzaFlavors = products.filter(p => p.category === "pizzas");
      if (pizzaFlavors.length === 0){
        toast("Cadastre pizzas primeiro üçï", "info");
        return;
      }

      els.flavor1.innerHTML = pizzaFlavors.map(p => `<option value="${p.id}">${escapeHtml(p.name)}</option>`).join("");
      els.flavor2.innerHTML = pizzaFlavors.map(p => `<option value="${p.id}">${escapeHtml(p.name)}</option>`).join("");

      pizzaState.size = "M";
      pizzaState.half = false;
      pizzaState.flavor1Id = defaultFlavorId || pizzaFlavors[0].id;
      pizzaState.flavor2Id = pizzaFlavors[1]?.id || pizzaState.flavor1Id;
      pizzaState.notes = "";

      els.flavor1.value = pizzaState.flavor1Id;
      els.flavor2.value = pizzaState.flavor2Id;
      els.pizzaNotes.value = "";

      setSegActive(els.sizeSeg, "data-size", pizzaState.size);
      setSegActive(els.halfSeg, "data-half", "0");

      updatePizzaPrice();
      els.pizzaModal.style.display = "flex";
    }

    function closePizzaModal(){ els.pizzaModal.style.display = "none"; }

    els.sizeSeg.addEventListener("click", (e) => {
      const b = e.target.closest("button[data-size]");
      if (!b) return;
      pizzaState.size = b.dataset.size;
      setSegActive(els.sizeSeg, "data-size", pizzaState.size);
      updatePizzaPrice();
    });

    els.halfSeg.addEventListener("click", (e) => {
      const b = e.target.closest("button[data-half]");
      if (!b) return;
      pizzaState.half = b.dataset.half === "1";
      setSegActive(els.halfSeg, "data-half", pizzaState.half ? "1" : "0");
      updatePizzaPrice();
    });

    els.flavor1.addEventListener("change", () => { pizzaState.flavor1Id = els.flavor1.value; updatePizzaPrice(); });
    els.flavor2.addEventListener("change", () => { pizzaState.flavor2Id = els.flavor2.value; updatePizzaPrice(); });
    els.pizzaNotes.addEventListener("input", () => { pizzaState.notes = els.pizzaNotes.value; });

    els.pizzaClose.addEventListener("click", closePizzaModal);
    els.pizzaCancel.addEventListener("click", closePizzaModal);
    els.pizzaModal.addEventListener("click", (e) => { if (e.target === els.pizzaModal) closePizzaModal(); });

    els.pizzaAdd.addEventListener("click", () => {
      const f1 = products.find(p => p.id === pizzaState.flavor1Id);
      const f2 = products.find(p => p.id === pizzaState.flavor2Id);
      if (!f1) return;

      const p1 = priceForSize(f1, pizzaState.size);
      let unit = p1;
      let name = `Pizza ${f1.name} (${pizzaState.size})`;

      if (pizzaState.half && f2){
        const p2 = priceForSize(f2, pizzaState.size);
        unit = Math.max(p1, p2);
        name = `Pizza Meio a Meio: ${f1.name} + ${f2.name} (${pizzaState.size})`;
      }

      const notes = (pizzaState.notes || "").trim();
      const key = `pizza|${pizzaState.size}|${pizzaState.half ? "half" : "full"}|${pizzaState.flavor1Id}|${pizzaState.half ? pizzaState.flavor2Id : ""}|${notes}`;

      const existing = cart.get(key);
      if (existing) existing.qty += 1;
      else cart.set(key, {
        name,
        qty: 1,
        unit_price: unit,
        notes,
        is_kitchen: true,
        emoji: "üçï"
      });

      closePizzaModal();
      renderCart();
    });

    // ===== Clique produtos (add/edit/del) =====
    els.products.addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-action]");
      if (!btn) return;

      const card = e.target.closest(".prod");
      if (!card) return;

      const id = card.dataset.id;
      const p = products.find(x => x.id === id);
      if (!p) return;

      const action = btn.dataset.action;

      if (action === "add"){
        if (closingTableId){
          toast("Finalize a mesa antes de adicionar itens.", "info");
          return;
        }
        if (p.category === "pizzas"){
          openPizzaModal(p.id);
          return;
        }

        const key = `item|${p.id}`;
        const existing = cart.get(key);
        if (existing) existing.qty += 1;
        else cart.set(key, {
          name: p.name,
          qty: 1,
          unit_price: Number(p.price || 0),
          notes: "",
          is_kitchen: !!p.isKitchen,
          emoji: p.emoji || "üßæ"
        });

        renderCart();
      }

      if (action === "edit"){
        if (!requireManager()) return;
        openProductModal("edit", p);
      }

      if (action === "del"){
        if (!requireManager()) return;
        deleteProduct(p.id);
      }
    });

    // ===== Checkout =====
    function calcTotals(){
      let subtotal = 0;
      for (const it of cart.values()) subtotal += it.unit_price * it.qty;
      const discount = 0;
      const fee = 0;
      const total = Math.max(0, subtotal - discount + fee);
      return { subtotal, discount, fee, total };
    }

    function unlockCheckoutFields(){
      const fields = [
        els.orderType, els.tableNo, els.custName, els.custPhone,
        els.custAddress, els.orderNotes, els.paymentMethod
      ];
      for (const f of fields){
        if (!f) continue;
        f.disabled = false;
        f.readOnly = false;
      }
      if (els.checkoutConfirm) els.checkoutConfirm.disabled = false;
    }

    function forceEnableCheckoutModal(){
      if (!els.checkoutModal) return;
      els.checkoutModal.style.pointerEvents = "auto";
      const modalBox = els.checkoutModal.querySelector(".modal");
      if (modalBox) modalBox.style.pointerEvents = "auto";
      const all = els.checkoutModal.querySelectorAll("input, select, textarea, button");
      all.forEach(el => {
        el.disabled = false;
        el.readOnly = false;
        el.removeAttribute("disabled");
        el.removeAttribute("readonly");
      });
    }

    function resetCheckoutState(){
      closingTableId = null;
      unlockCheckoutFields();
      forceEnableCheckoutModal();
      updatePaymentVisibility();
      if (els.checkoutConfirm) els.checkoutConfirm.innerHTML = "Salvar e Imprimir";
      if (els.checkoutModal) els.checkoutModal.style.display = "none";
    }

    function clearCheckoutInvalid(){
      [els.orderType, els.tableNo, els.custName, els.custPhone, els.custAddress].forEach(el => {
        if (el) el.classList.remove("invalid");
      });
    }

    function onlyDigits(s){ return String(s || "").replace(/\D/g, ""); }
    function isValidPhone(phone){
      const d = onlyDigits(phone);
      return d.length >= 10;
    }

    function validateCheckout(){
      clearCheckoutInvalid();
      const type = els.orderType.value;
      const table = els.tableNo.value.trim();
      const name = els.custName.value.trim();
      const phone = els.custPhone.value.trim();
      const address = els.custAddress.value.trim();

      if (type === "mesa"){
        if (!table){
          els.tableNo.classList.add("invalid");
          els.tableNo.focus();
          toast("Informe a mesa.", "error");
          return false;
        }
        return true;
      }

      if (!name){
        els.custName.classList.add("invalid");
        els.custName.focus();
        toast("Informe o nome do cliente.", "error");
        return false;
      }

      if (!phone){
        els.custPhone.classList.add("invalid");
        els.custPhone.focus();
        toast("Informe o telefone.", "error");
        return false;
      }

      if (!isValidPhone(phone)){
        els.custPhone.classList.add("invalid");
        els.custPhone.focus();
        toast("Telefone inv√°lido.", "error");
        return false;
      }

      if (type === "entrega" && !address){
        els.custAddress.classList.add("invalid");
        els.custAddress.focus();
        toast("Informe o endere√ßo.", "error");
        return false;
      }

      return true;
    }

    function closeOtherModals(){
      if (els.productModal) els.productModal.style.display = "none";
      if (els.pizzaModal) els.pizzaModal.style.display = "none";
      if (els.opsModal) els.opsModal.style.display = "none";
      if (els.reportsModal) els.reportsModal.style.display = "none";
      if (els.systemModal) els.systemModal.style.display = "none";
      if (els.categoryModal) els.categoryModal.style.display = "none";
      if (els.emojiModal) els.emojiModal.style.display = "none";
      if (typeof opsPoll !== "undefined" && opsPoll){
        clearInterval(opsPoll);
        opsPoll = null;
      }
    }

    function openCheckout(){
      closeOtherModals();
      clearCheckoutInvalid();
      unlockCheckoutFields();
      forceEnableCheckoutModal();
      const t = calcTotals();
      els.checkoutTotal.value = brl(t.total);
      els.checkoutModal.style.display = "flex";
      updatePaymentVisibility();
      els.custName.focus();
    }

    function closeCheckout(){
      els.checkoutModal.style.display = "none";
      unlockCheckoutFields();
    }

    els.finishBtn.addEventListener("click", () => {
      if (cart.size === 0){ toast("Carrinho vazio üòÖ", "info"); return; }
      openCheckout();
    });

    els.checkoutClose.addEventListener("click", closeCheckout);
    els.checkoutCancel.addEventListener("click", closeCheckout);
    els.checkoutModal.addEventListener("click", (e) => { if (e.target === els.checkoutModal) closeCheckout(); });

    function closeAnyModal(){
      if (els.checkoutModal && els.checkoutModal.style.display === "flex"){
        closeCheckout();
        return true;
      }
      if (els.productModal && els.productModal.style.display === "flex"){
        els.productModal.style.display = "none";
        return true;
      }
      if (els.pizzaModal && els.pizzaModal.style.display === "flex"){
        closePizzaModal();
        return true;
      }
      if (els.opsModal && els.opsModal.style.display === "flex"){
        closeOpsModal();
        return true;
      }
      if (els.reportsModal && els.reportsModal.style.display === "flex"){
        closeReportsModal();
        return true;
      }
      if (els.systemModal && els.systemModal.style.display === "flex"){
        closeSystemModal();
        return true;
      }
      if (els.categoryModal && els.categoryModal.style.display === "flex"){
        closeCategoryModal();
        return true;
      }
      if (els.emojiModal && els.emojiModal.style.display === "flex"){
        closeEmojiModal();
        return true;
      }
      return false;
    }

    // ===== Atalhos (F2, F4, Esc, Ctrl+P) =====
    document.addEventListener("keydown", (e) => {
      const key = e.key;
      const isCtrlP = (e.ctrlKey || e.metaKey) && key.toLowerCase() === "p";

      if (isCtrlP){
        e.preventDefault();
        reprintLastOrder();
        return;
      }

      if (!e.altKey && key === "F2"){
        e.preventDefault();
        if (els.checkoutModal && els.checkoutModal.style.display === "flex"){
          if (els.checkoutConfirm && !els.checkoutConfirm.disabled) els.checkoutConfirm.click();
          return;
        }
        if (cart.size === 0){ toast("Carrinho vazio üòÖ", "info"); return; }
        openCheckout();
        return;
      }

      if (!e.altKey && key === "F4"){
        e.preventDefault();
        reprintLastOrder();
        return;
      }

      if (key === "Escape"){
        if (closeAnyModal()) e.preventDefault();
      }
    });

    function updatePaymentVisibility(){
      const isMesa = els.orderType.value === "mesa";
      const needsPay = (!isMesa) || (closingTableId !== null);

      if (els.paymentBlock && els.paymentRow){
        els.paymentBlock.style.display = needsPay ? "grid" : "none";
        els.paymentRow.style.gridTemplateColumns = needsPay ? "1fr 1fr" : "1fr";
      }

      if (!needsPay){
        els.metaPay.textContent = "A pagar";
      } else {
        const v = els.paymentMethod.value;
        els.metaPay.textContent = v === "pix" ? "PIX" : v.charAt(0).toUpperCase() + v.slice(1);
      }
    }

    // Atualiza meta tags no carrinho (s√≥ visual)
    els.orderType.addEventListener("change", () => {
      els.metaType.textContent = els.orderType.value.charAt(0).toUpperCase() + els.orderType.value.slice(1);
      updatePaymentVisibility();
    });
    els.paymentMethod.addEventListener("change", () => {
      const v = els.paymentMethod.value;
      els.metaPay.textContent = v === "pix" ? "PIX" : v.charAt(0).toUpperCase() + v.slice(1);
    });

    // Salvar e imprimir
    els.checkoutConfirm.addEventListener("click", async () => {
      if (cart.size === 0){ toast("Carrinho vazio üòÖ", "info"); return; }
      if (!validateCheckout()) return;

      const totals = calcTotals();
      const isMesa = els.orderType.value === "mesa";
      const payNow = (!isMesa) || (closingTableId !== null);
      const payment = payNow ? els.paymentMethod.value : "";

      const payload = {
        order_type: els.orderType.value,
        table_no: els.tableNo.value.trim(),
        customer_name: els.custName.value.trim(),
        customer_phone: els.custPhone.value.trim(),
        address: els.custAddress.value.trim(),
        notes: els.orderNotes.value.trim(),

        payment_method: payment,
        totals,

        items: Array.from(cart.values()).map(it => ({
          name: it.name,
          qty: it.qty,
          unit_price: it.unit_price,
          notes: it.notes || "",
          is_kitchen: !!it.is_kitchen
        }))
      };

      try{
        setButtonLoading(els.checkoutConfirm, true, "Salvando...");

        if (closingTableId){
          if (!payment) throw new Error("Informe o pagamento para fechar a mesa");

          const resp = await fetch(`/api/orders/${closingTableId}/finalize`, {
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({
              order_type: payload.order_type,
              table_no: payload.table_no,
              customer_name: payload.customer_name,
              customer_phone: payload.customer_phone,
              address: payload.address,
              notes: payload.notes,
              payment_method: payment
            })
          });

          const data = await resp.json();
          if (!data.ok) throw new Error(data.error || "Erro");

          closeCheckout();
          setLastOrderId(closingTableId);
          window.open(`/api/orders/${closingTableId}/print?prices=1`, "_blank");

          closingTableId = null;
          updatePaymentVisibility();
          cart.clear();
          renderCart();
        } else {
          const resp = await fetch("/api/orders", {
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify(payload)
          });

          const data = await resp.json();
          if (!data.ok) throw new Error(data.error || "Erro");

          closeCheckout();
          setLastOrderId(data.order_id);
          window.open(`/api/orders/${data.order_id}/print?prices=1`, "_blank");

          cart.clear();
          renderCart();
        }

      } catch (e){
        toast("Erro ao salvar/imprimir: " + e.message, "error", { detail: e?.stack || e?.message });
      } finally {
        setButtonLoading(els.checkoutConfirm, false);
      }
    });

    // ===== Caixa: abrir/fechar + relat√≥rio =====
    els.cashPill.addEventListener("click", async () => {
      if (!requireManager()) return;
      if (els.cashPill.classList.contains("loading")) return;

      if (shiftState.open){
        const ok = confirm("Tem certeza que deseja FECHAR o caixa e gerar relat√≥rio?");
        if (!ok) return;
        setBusy(els.cashPill, true);

        try{
          const resp = await fetch("/api/cash/close", { method:"POST" });
          const data = await resp.json().catch(() => null);
          if (!resp.ok || data?.ok === false) throw new Error(data?.error || "Erro ao fechar caixa");

          shiftState.open = false;
          saveShift();
          renderShift();
          resetCheckoutState();

          window.open("/api/cash/report/print", "_blank");
          toast("Caixa fechado com sucesso.", "success");
        } catch (e){
          toast("Falha ao fechar caixa: " + e.message, "error", { detail: e?.stack || e?.message });
        } finally {
          setBusy(els.cashPill, false);
        }
      } else {
        const ok = confirm("Deseja ABRIR o caixa novamente?");
        if (!ok) return;
        setBusy(els.cashPill, true);

        try{
          const resp = await fetch("/api/cash/open", { method:"POST" });
          const data = await resp.json().catch(() => null);
          if (!resp.ok || data?.ok === false) throw new Error(data?.error || "Erro ao abrir caixa");

          shiftState.open = true;
          saveShift();
          renderShift();
          resetCheckoutState();
          toast("Caixa aberto com sucesso.", "success");
        } catch (e){
          toast("Falha ao abrir caixa: " + e.message, "error", { detail: e?.stack || e?.message });
        } finally {
          setBusy(els.cashPill, false);
        }
      }
    });

    // ===== IMPORTA√á√ÉO XML =====
    function parseNumberFlexible(s){
      const norm = String(s ?? "").trim().replace(",", ".");
      const n = Number(norm);
      return Number.isFinite(n) ? n : NaN;
    }

    function parseMenuXml(xmlText){
      const parser = new DOMParser();
      const doc = parser.parseFromString(xmlText, "application/xml");

      if (doc.querySelector("parsererror")) {
        throw new Error("XML inv√°lido (verifique as tags).");
      }

      const nodes = Array.from(doc.querySelectorAll("cardapio > produto"));
      if (!nodes.length) throw new Error("Nenhum <produto> encontrado em <cardapio>.");

      const imported = [];

      for (const n of nodes){
        const get = (selector) => (n.querySelector(selector)?.textContent ?? "").trim();
        const name = get("nome");
        const rawCategory = (get("categoria") || "").trim();
        const category = normalizeCategoryId(rawCategory);
        const emoji = get("emoji") || (category === "pizzas" ? "üçï" : "üßæ");
        const desc = get("descricao");
        const cozinhaTxt = (get("cozinha") || "").toLowerCase();
        const isKitchen = (cozinhaTxt === "" ? (category === "pizzas") : (cozinhaTxt === "true" || cozinhaTxt === "1" || cozinhaTxt === "sim"));

        if (!name) continue;
        if (!category) continue;

        if (!categories.find(c => c.id === category)){
          const label = rawCategory || prettyCatLabel(category);
          categories.push({ id: category, label, emoji: guessCategoryEmoji(label) });
          saveCategories(categories);
        }

        if (category === "pizzas"){
          const p = parseNumberFlexible(get("precos > p"));
          const m = parseNumberFlexible(get("precos > m"));
          const g = parseNumberFlexible(get("precos > g"));
          if (![p,m,g].every(v => Number.isFinite(v) && v >= 0)) continue;

          imported.push({
            id: uid(),
            name, category, emoji, desc,
            priceP: p, priceM: m, priceG: g,
            isKitchen
          });
        } else {
          const price = parseNumberFlexible(get("preco"));
          if (!Number.isFinite(price) || price < 0) continue;

          imported.push({
            id: uid(),
            name, category, emoji, desc,
            price,
            isKitchen
          });
        }
      }

      if (!imported.length) throw new Error("Nenhum produto v√°lido encontrado no XML.");
      return imported;
    }

    function mergeProducts(existing, incoming){
      const out = [...existing];

      for (const inc of incoming){
        const idx = out.findIndex(p =>
          (p.category === inc.category) &&
          (String(p.name||"").trim().toLowerCase() === String(inc.name||"").trim().toLowerCase())
        );

        if (idx >= 0){
          out[idx] = { ...out[idx], ...inc, id: out[idx].id };
        } else {
          out.unshift(inc);
        }
      }
      return out;
    }

    els.importXmlBtn.addEventListener("click", () => {
      if (!requireManager()) return;
      els.xmlFileInput.value = "";
      els.xmlFileInput.click();
    });

    els.xmlFileInput.addEventListener("change", async () => {
      const file = els.xmlFileInput.files?.[0];
      if (!file) return;
      if (!requireManager()) return;

      try{
        setButtonLoading(els.importXmlBtn, true);
        const text = await file.text();
        const imported = parseMenuXml(text);

        const mode = confirm(
          `Importar ${imported.length} itens.\n\nOK = Mesclar/atualizar (recomendado)\nCancelar = Substituir tudo`
        );

        products = mode ? mergeProducts(products, imported) : imported;
        saveProducts(products);

        // se trocar tudo, mant√©m a categoria atual e atualiza
        ensureCategoriesFromProducts();
        renderCategoryTabs();
        renderCategorySelect();
        syncTabs();
        renderProducts();
        toast(`Importa√ß√£o conclu√≠da ‚úÖ (${imported.length} itens)`, "success");
      } catch (e){
        toast("Falha ao importar XML: " + e.message, "error", { detail: e?.stack || e?.message });
      } finally {
        setButtonLoading(els.importXmlBtn, false);
      }
    });

    // ===== Init =====
    ensureCategoriesFromProducts();
    renderCategorySelect();
    renderCategoryTabs();
    syncTabs();
    renderProducts();
    renderCart();
    renderRole();
    if (window.__MVS_DEMO_STORAGE) {
      toast("Modo demo em storage local ativo (sem SQLite).", "info", { timeout: 4800 });
    }
  </script>
</body>
</html>
